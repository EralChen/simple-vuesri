import{ew as w,gf as O,gi as v}from"./index-VvDgqKaS.js";import{b as j,n as d}from"./cimAnalyzer-MIAdrVOL.js";import{CIMSymbolRasterizer as G}from"./CIMSymbolRasterizer-nmnaFhIM.js";import{t as b,l as R}from"./symbolUtils-7gcSbjki.js";import"./BidiEngine-8z8MVveq.js";import"./labelPoint-1wm0QAjd.js";import"./Rect-pT1ASav_.js";import"./CIMResourceManager-7afjv5W-.js";import"./Rasterizer-So7ShSqV.js";import"./rasterizingUtils-XDirziwC.js";const f=new G(null,!0),u=w(b.size),S=w(b.maxSize),C=w(b.lineWidth),V=1;async function $(a,e,r){const l=e==null?void 0:e.size;let t=l!=null&&typeof l=="object"&&"width"in l?l.width:l,n=l!=null&&typeof l=="object"&&"height"in l?l.height:l;if(t==null||n==null)if(r==="esriGeometryPolygon")t=u,n=u;else{const i=await q(a,e,r);i&&(t=i.width,n=i.height),r==="esriGeometryPolyline"&&(t=C),t=t!=null&&isFinite(t)?Math.min(t,S):u,n=n!=null&&isFinite(n)?Math.max(Math.min(n,S),V):u}return e.style==="legend"&&r==="esriGeometryPolyline"&&(t=C),{width:t,height:n}}async function q(a,e,r){const{feature:l,fieldMap:t,viewParams:n}=e.cimOptions||e,i=await j.resolveSymbolOverrides(a.data,l,null,t,r,null,n);if(!i)return null;(a=a.clone()).data={type:"CIMSymbolReference",symbol:i},a.data.primitiveOverrides=void 0;const o=[];return d.fetchResources(i,f.resourceManager,o),d.fetchFonts(i,f.resourceManager,o),o.length>0&&await Promise.all(o),d.getEnvelope(i,null,f.resourceManager)}async function K(a,e={}){var M;const{node:r,opacity:l,symbolConfig:t}=e,n=t!=null&&typeof t=="object"&&"isSquareFill"in t&&t.isSquareFill,i=e.cimOptions||e,o=i.geometryType||O((M=a==null?void 0:a.data)==null?void 0:M.symbol),h=await $(a,e,o),{feature:P,fieldMap:I}=i,L=n||o!=="esriGeometryPolygon"?"preview":"legend",p=await f.rasterizeCIMSymbolAsync(a,P,h,L,I,o,null,i.viewParams,i.allowScalingUp);if(!p)return null;const{width:x,height:z}=p,m=document.createElement("canvas");m.width=x,m.height=z,m.getContext("2d").putImageData(p,0,0);const y=v(h.width),g=v(h.height),s=new Image(y,g);s.src=m.toDataURL(),s.ariaLabel=e.ariaLabel??null,s.alt=e.ariaLabel??"",l!=null&&(s.style.opacity=`${l}`);let c=s;if(e.effectView!=null){const F={shape:{type:"image",x:0,y:0,width:y,height:g,src:s.src},fill:null,stroke:null,offset:[0,0]};c=R([[F]],[y,g],{effectView:e.effectView,ariaLabel:e.ariaLabel})}return r&&c&&r.appendChild(c),c}export{K as previewCIMSymbol};
