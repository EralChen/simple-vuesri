import{E as p,F as c,H as V,M as Lt,dp as tn,sC as en,aa as an,aF as y,d6 as nn,aN as Z,at as it,nR as ie,rh as Sa,A8 as on,rl as sn,jM as rn,jI as ln,h$ as wa,i2 as $t,l5 as xa,l3 as Oa,q7 as hn,l2 as pn,eA as de,jL as Ze,nU as cn,dU as H,aM as ae,li as Ea,mh as U,A9 as dn,Aa as I,oc as un,jn as be,c4 as ft,nE as Ii,nG as oi,mo as Pi,nH as gn,dT as ot,ke as Et,ld as It,mf as zi,Ab as _n,dA as mn,ml as Li,dy as fn,jc as vn,fy as yn,tU as Mn,Ac as bn,jt as Be,is as Aa,gP as $e,lx as Sn,es as k,rx as wn,t7 as xn,du as B,Ad as Hi,v1 as vi,dj as Zt,P as $,K as C,Ae as On,q8 as En,Af as yi,dv as Pt,rg as je,Ag as Ta,mt as Ce,bX as An,dP as Vi,dO as Tn,Ah as Dn,jK as Gn,Ai as Da,l1 as We,Aj as Ie,Ak as Ga,kr as ki,lc as w,o7 as j,vD as O,Al as Rn,oa as Re,o6 as Ra,na as q,o9 as Pe,mp as Mi,nX as bi,gJ as qe,lg as $n,Am as Cn,jw as yt,An as In,Ao as Pn,rv as zn,lb as z,dS as di,nA as ze,dR as zt,Ap as Ln,Aq as Hn,Ar as $a,mr as Ca,e0 as ui,b1 as Vn,V as kn,eB as Ht,D as Si,As as Un,At as Ia,rE as Xn,ed as Se,ny as Pa,nx as wi,vr as za,Au as Fn,l9 as Ui,ec as Nn,Av as Yn,r5 as Xi,rK as Zn,nv as ne,nY as Oe,ge as Bn,la as Ut,rD as Fi,Aw as jn,c0 as Wn,rC as xt,cB as qn,t4 as La,Ax as Kn,Ay as Jn,aG as Le,o8 as Qn,Az as Ni,rB as to,km as ue,AA as eo,ep as me,AB as io,rn as ao,AC as Yi,AD as Zi,s4 as no,s7 as oo,AE as so,eE as gi,s5 as Bi,s9 as ro,s6 as lo,bA as ho,k as po,AF as co,o2 as Ha,nu as Va,gH as _i,o1 as fe,n_ as ge,ku as uo,t9 as go,e9 as Ft,el as _o}from"./index-VvDgqKaS.js";import{e as mo,q as fo}from"./quantityFormatUtils-QN9-Yno0.js";import{x as vo}from"./TextOverlayItem-NUCJmzev.js";import{l as yo,a as At,u as we,s as Ke,p as Mo,b as bo,c as Ee}from"./Tooltip-GfA9Ra_H.js";import{V as ka,O as ve,d as ji,G as xi}from"./VerticesVisualElement-N7QI4MT6.js";import{t as So}from"./RightAngleQuadVisualElement-ux-euBAj.js";import{c as He,x as wo}from"./Laserlines.glsl-X3sf4m58.js";import{K as xo,k as Oo,X as Eo,o as Ao,r as To,g as Do,V as Je,l as Go,x as Wi}from"./editPlaneUtils-si1m9XaU.js";import{h as _t,m as Ve,i as ye,o as si,n as qi}from"./unitFormatUtils-UwjGTfCU.js";import{$ as st,e as x,w as Ot,k as Ua,b as he,v as Xa,F as Fa}from"./ShadedColorMaterial.glsl-edIY5xq2.js";import{n as Nt}from"./manipulatorUtils-YxtV5LrA.js";import{T as Oi,P as Na,M as Ro,U as $o,k as Co,D as Io,H as Ei,l as Po}from"./Factory-eSioOnhw.js";import{x as zo,z as Lo,d as dt,D as _e,y as Ho,q as se,U as Ya,P as Qt,l as Qe,j as Vo,w as ko,C as Ki,O as Uo}from"./InteractiveToolBase-2RE5Fzsg.js";import{S as Xo}from"./GraphicManipulator-N3oDONkC.js";import{V as ti,y as Ji,N as Fo,E as Tt,e as Za}from"./EditGeometryOperations-yUVJb2Yp.js";import{e as ke}from"./SnappingContext-ECUTZVsr.js";import{f as Ue}from"./SnappingOperation-zK7DWLMu.js";import{r as Me,a as ei,l as Ai,n as No,c as Yo,p as Zo}from"./TranslateTooltipInfos-e_wtvpXq.js";import{y as Xe,R as Bo,d as jo}from"./euclideanLengthMeasurementUtils--2b7DoZG.js";import{o as Wo}from"./automaticAreaMeasurementUtils-gahik75u.js";import{I as qo,H as Ko,y as Jo,g as Qo,c as ts,C as es,a as is,h as as,z as Ba,B as Qi,d as ns,N as os,D as ss}from"./SlicePlaneMaterial.glsl-Bw99cu3H.js";import{i as rs,p as ls}from"./ExtentTooltipInfos-HyY7z8TT.js";import"./geometryEngine-VO9oO-_X.js";import"./geometryEngineBase-D_2Tm-9b.js";import"./hydrated-Qn2DORmw.js";import"./memoize-uBdPJ80n.js";import"./LineVisualElement-CLLuWDoo.js";import"./measurementUtils-IJUpjgN0.js";import"./dehydratedFeatureComparison-hLkDFZD_.js";import"./drawUtils-oqrUlJv2.js";import"./PointSnappingHint--d9S62VE.js";import"./euclideanAreaMeasurementUtils-6cDNkTcX.js";import"./ImageMaterial.glsl-EyGZfxro.js";const hs=3025,ps={default:15,far:25};let lt=class extends Lt{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=tn(async e=>{const a=await en("esri/core/t9n/Units");an(e),this._messagesUnits=a});this.addHandles([y(()=>[this.context!=null&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(e=>nn(()=>{var a;return(a=this.context)==null?void 0:a.editGeometryOperations},e,()=>this._update())),Z(()=>t.abort()),y(()=>this._colors,e=>this._updateStyle(e))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return this._messagesUnits==null}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(t=>t.label.text)}}get _edgeDistancePixels(){return ps[this.edgeDistance]}get _colors(){var e;const t=((e=this.context)==null?void 0:e.view.effectiveTheme.textColor)??it.fromArray([255,255,255]);return{textColor:t,backgroundColor:ie(Sa(t,on.Low),.6)}}_update(){if(this.destroyed)return;this._nextLabelIndex=0;const t=this.context;if(t==null)return void this._destroyUnusedLabels();const{components:e,geometry:a,coordinateHelper:n}=t.editGeometryOperations.data;if(!a)return void this._destroyUnusedLabels();const o=e.length;for(let s=0;s<o;++s){const r=[];if(e[s].iterateVertices(_=>{r.push(n.toXYZ(_.pos))}),s===0&&this.stagedVertex!=null&&r.push(n.toXYZ(this.stagedVertex)),r.length<2)continue;const l=r[0],h=r[r.length-1];a.type==="polygon"&&r.length>2&&!sn(l,h)&&r.push(l);const d=o===1&&!rn(r);let u=cs,g=ds;this.toScreenPointArray(t,l,u);for(let _=1;_<r.length;++_){const m=r[_-1],f=r[_];this.toScreenPointArray(t,f,g),this._addLabel(t,m,u,f,g,d),[u,g]=[g,u]}}this._destroyUnusedLabels()}_updateStyle({textColor:t,backgroundColor:e}){const a=this._nextLabelIndex,n=this._labelInfos;for(let o=0;o<a;++o){const{label:s}=n[o];s.textColor=t,s.backgroundColor=e}}_addLabel(t,e,a,n,o,s){const{label:r}=this._getOrCreateLabel(t);if(!this.visible||ln(a,o)<hs)return void(r.visible=!1);const l=t.graphicState!=null?t.graphicState.isDraped?"on-the-ground":"absolute-height":wa(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:h}=t.editGeometryOperations.data,d=yo(e,n,h,l),u=this._messagesUnits,g=mo(t.view);r.text=u!=null&&d!=null?fo(u,d,g):"",r.visible=!0;const _=o[0]-a[0],m=o[1]-a[1];s?$t(rt,-m,_):$t(rt,m,-_),xa(rt,rt),Oa(rt,rt,this._edgeDistancePixels),hn(pe,a,o,.5),pn(pe,pe,rt),r.position=[pe[0],pe[1]],Math.abs(rt[0])>Math.abs(rt[1])?r.anchor=rt[0]>0?"left":"right":r.anchor=-rt[1]<0?"top":"bottom"}_getOrCreateLabel(t){var r;const e=this._labelInfos.length>this._nextLabelIndex,{textColor:a,backgroundColor:n}=this._colors;if(e){const l=this._labelInfos[this._nextLabelIndex++],{label:h}=l;return h.textColor=a,h.backgroundColor=n,l}const o=new vo({anchor:"center",fontSize:10,textColor:a,backgroundColor:n});(r=t.view.overlay)==null||r.items.add(o);const s={label:o};return this._labelInfos.push(s),this._nextLabelIndex=this._labelInfos.length,s}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){var e,a;(a=(e=this.context)==null?void 0:e.view.overlay)==null||a.items.remove(t),t.destroy()}};p([c()],lt.prototype,"context",void 0),p([c()],lt.prototype,"stagedVertex",void 0),p([c()],lt.prototype,"visible",void 0),p([c()],lt.prototype,"edgeDistance",void 0),p([c()],lt.prototype,"updating",null),p([c()],lt.prototype,"_messagesUnits",void 0),p([c()],lt.prototype,"_edgeDistancePixels",null),p([c()],lt.prototype,"_colors",null),lt=p([V("esri.views.interactive")],lt);const rt=de(),pe=de(),cs=Ze(),ds=Ze();let Fe=class extends lt{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:a},n,o=Ze()){const{spatialReference:s}=a.data.coordinateHelper;return cn(n,s,e,t,ta),t.state.camera.projectToScreen(ta,o),o}};Fe=p([V("esri.views.3d.interactive.SegmentLabels3D")],Fe);const ta=H();function Ti(i){const{graphic:t}=i;return[y(()=>i.displaying,e=>{e?us(t):ea(t)},{...ae}),Z(()=>ea(t))]}function us(i){const{geometry:t}=i;ja(t)&&i.notifyMeshTransformChanged({action:Ea.EnableFastUpdates})}function ea(i){const{geometry:t}=i;ja(t)&&i.notifyMeshTransformChanged({action:Ea.DisableFastUpdates})}function ja(i){return(i==null?void 0:i.type)==="mesh"&&!i.vertexSpace.isGeoreferenced}const ee=.3;function re(i,t){t&&Object.assign(i,t)}let gs=class{constructor(t){this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=U.Opaque,this.color=t.accent}},ri=class{constructor({colors:t,...e}){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=t.accent,this.outlineColor=t.outline,this.renderOccluded=U.Opaque,this.hoverOutlineColor=t.selectedOutline,re(this,e)}applyColor(t){this._apply(this.color,t)}applyOutline(t){this._apply(this.outlineColor,t)}applyHoverOutline(t){this._apply(this.hoverOutlineColor,t)}_apply(t,e){e.setParameters({color:I(t),renderOccluded:this.renderOccluded})}},_s=class{constructor({colors:t,...e}){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.renderOccluded=U.Transparent,this.minSquaredEdgeLength=900,this.color=ie(t.accent,.5),this.hoverColor=t.accent,re(this,e)}applyColor(t){this._apply(this.color,t)}applyHover(t){this._apply(this.hoverColor,t)}_apply(t,e){e.setParameters({color:I(t),renderOccluded:this.renderOccluded})}},ms=class{constructor(t){this.vertex=new ri({colors:t,color:t.accent,outlineColor:t.outline}),this.edge=new ri({colors:t,color:dn(ie(t.accent,2/3),.5),outlineColor:ie(t.outline,.5),size:8,collisionPadding:8}),this.selected=new ri({colors:t,color:t.selected,outlineColor:t.outline}),this.edgeOffset=new _s({colors:t})}},mi=class{constructor({colors:t,...e}){this.width=1.5,this.stipplePattern=un(3.3),this.falloff=0,this.innerWidth=1.5,this.renderOccluded=U.OccludeAndTransparent,this.color=t.selected,this.stippleOffColor=t.outline,this.innerColor=t.selected,re(this,e)}apply(t){t.color=I(this.color),t.width=this.width,t.stipplePattern=this.stipplePattern,t.stippleOffColor=I(this.stippleOffColor),t.falloff=this.falloff,t.innerWidth=this.innerWidth,t.innerColor=I(this.innerColor),t.renderOccluded=this.renderOccluded}};class fs{constructor({colors:t,...e}){this.size=4,this.outlineSize=1,this.shape="square",this.color=t.selected,this.outlineColor=t.outline,re(this,e)}apply(t){t.color=I(this.color),t.size=this.size,t.outlineSize=this.outlineSize,t.outlineColor=I(this.outlineColor),t.primitive=this.shape}}class Ne{constructor({colors:t,...e}){this.innerWidth=1,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=ee,this.globalAlphaContrastBoost=1.5,this.radius=3,this.innerColor=t.selected,this.glowColor=t.accent,this.heightFillColor=t.accent,re(this,e)}apply(t,e=1){const a={glowColor:it.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:it.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*e*this.glowColor.a,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in t?t.style=a:t.laserlineStyle=a}}let vs=class{constructor(t){this.outline=new mi({colors:t,color:t.stippleOff,renderOccluded:U.OccludeAndTransparentStencil,stippleOffColor:t.stippleOn,innerWidth:0}),this.staged=new mi({colors:t,color:t.stippleOn,renderOccluded:U.OccludeAndTransparentStencil,innerColor:t.stagedSolid,stippleOffColor:t.stippleOff}),this.shadowStyle=new Ne({colors:t,globalAlpha:ee,glowColor:t.accent,glowFalloff:8,glowWidth:8,innerColor:t.selected,innerWidth:1})}};class ys{constructor(t){this.outline=new fs({colors:t,color:t.selected,outlineColor:t.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Ne({colors:t,globalAlpha:ee,glowColor:t.accent,glowFalloff:1.5,glowWidth:6,innerColor:t.selected,innerWidth:1,radius:2})}}let Ms=class extends mi{constructor({colors:t,...e}){super({colors:t}),this.extensionType=ka.GROUND_RAY,re(this,e)}},bs=class{constructor(t){this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,this.lineGraphics=new vs(t),this.pointGraphics=new ys(t),this.heightPlane=new Ne({colors:t,globalAlpha:ee,glowColor:t.accent,glowFalloff:8,glowWidth:8,innerColor:t.selected,innerWidth:1}),this.heightBox=new Ne({colors:t,globalAlpha:ee,glowColor:t.accent,glowFalloff:8,glowWidth:8,innerColor:t.selected,innerWidth:0,heightFillColor:t.accent}),this.zVerticalLine=new Ms({colors:t,color:ie(t.accent,5*ee/3),falloff:2,innerColor:ie(t.selected,0),renderOccluded:U.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:ka.GROUND_RAY})}},W=class extends Lt{constructor(t){super(t)}get colors(){const t=this.getTheme().accentColor,e=t.a;return{accent:t,contrast:Sa(t),selected:it.fromArray([255,255,255,e]),selectedOutline:it.fromArray([255,255,255,e]),staged:it.fromArray([12,207,255,e]),stagedSolid:it.fromArray([12,207,255,1]),outline:it.fromArray([0,0,0,.5*e]),stippleOn:it.fromArray([255,255,255,1]),stippleOff:it.fromArray([0,0,0,.5])}}get visualElements(){return new bs(this.colors)}get manipulators(){return new ms(this.colors)}get zManipulator(){return new gs(this.colors)}};p([c()],W.prototype,"colors",null),p([c()],W.prototype,"visualElements",null),p([c()],W.prototype,"manipulators",null),p([c()],W.prototype,"zManipulator",null),p([c()],W.prototype,"getTheme",void 0),W=p([V("esri.views.3d.interactive.editingTools.settings.Settings")],W);class Bt extends So{constructor(t){super(t),this._attachmentOrigin=be(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new ft,this._geometry=null,this._width=1,this._color=Ii(1,0,1,1),this._innerWidth=0,this._innerColor=Ii(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=U.OccludeAndTransparentStencil,this._attachmentOrigin.spatialReference=t.view.spatialReference,this._laserline=new He({view:t.view,isDecoration:t.isDecoration}),this.applyProperties(t),this.attached=t.attached??!0}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(t){return{view:t,createResources:e=>this._createObject3DResources(e),destroyResources:e=>this._destroyExternalResources(e),recreateGeometry:(e,a)=>{e.geometries.length=0,this._recreateGeometry(a,e.material,e.geometries)}}}createDrapedResourceFactory(t){return{view:t,createResources:()=>this._createDrapedResources(),destroyResources:e=>this._destroyExternalResources(e),recreateGeometry:e=>{e.geometries=this._createRenderGeometriesDraped(e.material),this._attachmentOriginChanged()}}}get _laserlineAttached(){return this.attached&&this.visible&&this._laserlineStyle!=null&&!this.isDraped&&this.laserlineEnabled}onAttachedChange(t){this._laserline.attached=this._laserlineAttached,t&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._updateMaterial())}get color(){return this._color}set color(t){oi(t,this._color)||(Pi(this._color,t),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(t){t!==this._innerWidth&&(this._innerWidth=t,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(t){oi(t,this._innerColor)||(Pi(this._innerColor,t),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(t){const e=t!=null!=(this._stipplePattern!=null);this._stipplePattern=t,e?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(t){t&&this._stippleOffColor&&oi(t,this._stippleOffColor)||(this._stippleOffColor=t?gn(t):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(t){t!==this._falloff&&(this._falloff=t,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(t){this._laserlineStyle=t,this._laserline.attached=this._laserlineAttached,t!=null&&(this._laserline.style=t)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(t){this._laserlineEnabled!==t&&(this._laserlineEnabled=t,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get attachmentOrigin(){var a;if(!this._attachmentOriginDirty)return this._attachmentOrigin;const t=(a=this.object3dResources.resources)==null?void 0:a.geometries;if(!t||t.length===0)return null;ot(jt,0,0,0);let e=0;for(const n of t)n.computeAttachmentOrigin(ia)&&(Et(jt,jt,ia),e++);return e===0?null:(It(jt,jt,1/e),this.view.renderCoordsHelper.fromRenderCoords(jt,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){this.object3dResources.resources!=null&&this.object3dResources.resources.material.setParameters(this._materialParameters),this.drapedResources.resources!=null&&this.drapedResources.resources.material.setParameters(this._materialParameters)}get _isClosed(){return this.geometry!=null&&this.geometry.type==="polygon"}get _materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this._isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration}}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===U.OccludeAndTransparentStencil?U.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(t,e,a){this._createRenderGeometries(e,a);for(const n of a)t.addGeometry(n);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_destroyExternalResources(t){t.geometries=[]}_createObject3DResources(t){const e=new zi(this._materialParameters),a=new Array;return this._recreateGeometry(t,e,a),{material:e,geometries:a,forEach:n=>{n(e),a.forEach(n)}}}_createDrapedResources(){const t=new zi(this._materialParameters);return{material:t,geometries:this._createRenderGeometriesDraped(t)}}_createRenderGeometriesDraped(t){const{geometry:e,view:a}=this,n=a.basemapTerrain.spatialReference;return e==null||n==null?[]:_n(e,n).lines.map(({position:o})=>{const s={overlayInfo:{spatialReference:n,renderCoordsHelper:a.renderCoordsHelper},attributeData:{position:o},removeDuplicateStartEnd:this._isClosed};return new mn(Li(t,s))})}calculateMapBounds(t){if(this.object3dResources.resources==null)return!1;const e=this.view.renderCoordsHelper;for(const a of this.object3dResources.resources.geometries){const n=a.attributes.get(fn.POSITION),o=vn(n.data.length);yn(n.data,e.spatialReference,0,o,this.view.spatialReference,0,n.data.length/3),Mn(t,o)}return!0}_createRenderGeometries(t,e){const a=this.geometry;if(a==null)return;const n=bn(a,this.view.elevationProvider,this.view.renderCoordsHelper,Be.fromElevationInfo(this.elevationInfo??new Aa({mode:wa(a,null)}))),o=new Array;for(const{position:s,mapPositions:r}of n.lines){const l={mapPositions:r,attributeData:{position:s},removeDuplicateStartEnd:this._isClosed};e.push(Li(t,l)),o.push(s)}this._laserline.pathVerticalPlane=o}}const ia=H(),jt=H();let at=class extends ft.EventedAccessor{constructor(t){super(t),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};p([c({constructOnly:!0})],at.prototype,"graphic",void 0),p([c()],at.prototype,"tracking",void 0),p([c()],at.prototype,"displaying",void 0),p([c()],at.prototype,"isDraped",void 0),at=p([V("esri.views.3d.layers.graphics.GraphicState")],at);function Ss(i,t){const e=i==null?void 0:i.geometry;if(!i||(e==null?void 0:e.type)!=="mesh"||!t)return;const{renderCoordsHelper:a,elevationProvider:n}=t,{camera:o}=t.state,{extent:s}=e,{center:r,spatialReference:l}=s,h=$e(l),d=Sn(l),u=$e(a.spatialReference),g=s.width*h,_=s.height*d,m=(s.zmax??0)*d,f=m-(s.zmin??0)*d,M=Math.max(g,_,f)/u,{x:b,y:v}=r,E=r.z??0;ot(Ae,b,v,E),a.toRenderCoords(Ae,l,Ae);const G=M/o.computeScreenPixelSizeAt(Ae);if(G>o.width*xs)return"meshTooClose";if(G<ws)return"meshTooFar";const X=k(i),{absoluteZ:Y}=wn(b,v,m,l,t,X);return Y<(n.getElevation(b,v,E,l,"ground")??0)*d+f*Os?"meshUnderground":"mesh"}const ws=20,xs=1,Os=.1,Ae=H();let Wt=class extends xo{constructor(i){super(i),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this._settings=new W({getTheme:()=>this.view.effectiveTheme}),this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:i,offset:t}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new Aa({mode:i,offset:t})}normalizeCtorArgs(i){if(!i.elevationInfo){const t=i.hasZ??!0;return{...i,elevationInfo:xn(t)}}return i}initializeGraphic(i){const{view:t}=this,e=this._createGraphicState=new at({graphic:i});return B([t.maskOccludee(i),t.trackGraphicState(e),y(()=>({element:this._outlineVisualElement,isDraped:e.isDraped}),({element:a,isDraped:n})=>{a&&(a.isDraped=n)},ae),this._setupLoadingIndicator(e),...Ti(e)])}updateDrawMeshTooltipInfo(i){const{graphic:t,tooltipOptions:e,view:a}=this;i.tooltipOptions=e,i.viewType=a.type,i.helpMessage=Ss(t,this.view),this.updateElevation(i.elevation)}makeDrawOperation(){const{geometryType:i}=this,t=i!=="circle"&&i!=="rectangle";return new Oo({view:this.view,manipulators:this.manipulators,geometryType:Eo(i),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Ao(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new To(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new ve,segmentLabels:t?new Fe:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Hi(this.hasZ,this.elevationInfo)==="on-the-ground",cursor:this.cursor})}onActiveVertexChanged(i){const{view:t}=this;if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[i],this._updateVerticalLineVisualElement(i),Z();const e=this._settings,a=e.manipulators.vertex,n=new ji({view:t,spatialReference:t.spatialReference,vertices:[i],elevationInfo:this.internalGraphicsLayer.elevationInfo,size:a.size,outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1,isDecoration:!0});this._activeVertexVisualElement=n;const o=e.visualElements.zVerticalLine,s=new xi({view:t,extensionType:o.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:U.OccludeAndTransparent,isDecoration:!0});this._verticalLineVisualElement=s;const r=B([y(()=>e.visualElements.zVerticalLine,l=>l.apply(s),$),y(()=>({selectedColor:I(e.colors.selected),outlineColor:I(e.manipulators.vertex.outlineColor)}),({selectedColor:l,outlineColor:h})=>{n.color=l,n.outlineColor=h},$),Z(()=>{this._activeVertexVisualElement=C(this._activeVertexVisualElement),this._verticalLineVisualElement=C(this._verticalLineVisualElement)})]);return n.attached=!0,r}_updateVerticalLineVisualElement(i){const t=this._verticalLineVisualElement;if(!t)return;const{renderCoordsHelper:e,elevationProvider:a}=this.view;ot(qt,i[0],i[1],i[2]),aa.setFromElevationInfo(this.elevationInfo),qt[2]=vi(qt,a,aa,e),e.toRenderCoords(qt,this.view.spatialReference,qt)?(t.setStartEndFromWorldDownAtLocation(qt),t.attached=!0):t.attached=!1}onOutlineChanged(i){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=i,Z();const t=this.internalGraphicsLayer.elevationInfo,{view:e}=this,a=this._settings,n=new Bt({view:e,geometry:i,elevationInfo:t,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Hi(this.hasZ,t)==="on-the-ground",attached:!1,isDecoration:!0});this._outlineVisualElement=n;const o=B([y(()=>a.visualElements.lineGraphics.outline,s=>s.apply(n),$),y(()=>a.visualElements.lineGraphics.shadowStyle,s=>s.apply(n),$),Z(()=>{this._outlineVisualElement=C(this._outlineVisualElement)})]);return n.attached=!0,n.laserlineEnabled=!0,o}onRegularVerticesChanged(i){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=i,Z();const{view:t}=this,e=this._settings,a=e.manipulators.vertex,n=new ji({view:t,spatialReference:t.spatialReference,vertices:i,elevationInfo:this.internalGraphicsLayer.elevationInfo,size:a.size,outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1,isDecoration:!0}),o=B([y(()=>({color:I(e.manipulators.vertex.color),outlineColor:I(e.manipulators.vertex.outlineColor)}),({color:s,outlineColor:r})=>{n.color=s,n.outlineColor=r},$),Z(()=>{this._verticesVisualElement=C(this._verticesVisualElement)})]);return n.attached=!0,this._verticesVisualElement=n,o}updateGraphicGeometry(i,t){if(this.geometryType==="mesh"&&(t==null?void 0:t.type)==="point"){const e=this.geometryToPlace;return e&&e.centerAt(t),void(e&&i.geometry===e?e.vertexSpace.isGeoreferenced?i.notifyGeometryChanged():i.notifyMeshTransformChanged():i.geometry=e)}super.updateGraphicGeometry(i,t)}_setupLoadingIndicator(i){const{drawOperation:t}=this;if(!this.geometryToPlace)return t.loading=!1,null;t.loading=!0;const e=Z(()=>{t.loading=!1});let a;const n=()=>a&&cancelAnimationFrame(a);return B([Zt(()=>i.displaying,()=>{n(),a=requestAnimationFrame(()=>e.remove())},{...ae,once:!0}),Z(n),e])}};p([c({constructOnly:!0})],Wt.prototype,"elevationInfo",void 0),p([c({constructOnly:!0})],Wt.prototype,"geometryType",void 0),p([c()],Wt.prototype,"type",void 0),p([c({constructOnly:!0})],Wt.prototype,"view",void 0),Wt=p([V("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Wt);const aa=new Be,qt=H();function Es(i){const t=Di(i);return En(Math.cos(t),Math.sin(t))}function Di(i){if(i==null||i.type!=="polyline"&&i.type!=="polygon")return 0;const t=i.type==="polyline"?i.paths:i.rings;for(const e of t)for(let a=0;a<e.length-1;a++){const n=e[a],o=e[a+1],s=n[0]-o[0],r=n[1]-o[1];if(s*s+r*r>On)return Math.atan2(o[1]-n[1],o[0]-n[0])}return 0}var ct;(function(i){i[i.NONE=0]="NONE",i[i.ANY=1]="ANY",i[i.Z=2]="Z",i[i.XY=4]="XY"})(ct||(ct={}));var D;(function(i){i[i.TRANSLATE_Z=0]="TRANSLATE_Z",i[i.TRANSLATE_XY=1]="TRANSLATE_XY",i[i.SCALE=2]="SCALE",i[i.ROTATE=3]="ROTATE",i[i.SCALE_ROTATE=4]="SCALE_ROTATE"})(D||(D={}));let Wa=class{constructor(){this.grabbingState=ct.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=ct.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator((e,a)=>{if(a===D.TRANSLATE_Z&&(this.zManipulator=e),e instanceof st&&(e.selected&&(this.numSelected===0&&(this.firstSelected=e),this.numSelected++),this.firstGrabbedXY==null&&e.grabbing&&a===D.TRANSLATE_XY&&(this.firstGrabbedXY=e)),e.grabbing)switch(this.grabbingState|=ct.ANY,a){case D.TRANSLATE_Z:this.grabbingState|=ct.Z;break;case D.TRANSLATE_XY:this.grabbingState|=ct.XY}})}};function As(i){const{view:t,graphic:e}=i,a=new at({graphic:e}),n=Ts(i,a),o=[n,Ds(i,n.visualElement,a),t.maskOccludee(e),t.trackGraphicState(a)];return{visualElement:n.visualElement,remove:()=>yi(o)}}function Ts(i,t){const{view:e,graphic:a}=i,n=new Bt({view:e,geometry:fi(a)?a.geometry:null,elevationInfo:k(a),attached:!1,isDecoration:!0}),o=new W({getTheme:()=>e.effectiveTheme}),s=()=>{n.attached=t.displaying},r=B([y(()=>o.visualElements.lineGraphics.outline,l=>l.apply(n),$),y(()=>o.visualElements.lineGraphics.shadowStyle,l=>l.apply(n),$),y(()=>t.displaying,s),y(()=>t.isDraped,l=>{n.isDraped=l}),t.on("changed",()=>n.geometry=fi(a)?a.geometry:null),Pt(n)]);return s(),{visualElement:n,remove:()=>r.remove()}}function Ds(i,t,e){const{graphic:a,view:n}=i,o=[],s=k(a),r=s.mode==="on-the-ground"||!s.offset&&s.mode!=="absolute-height",l=new Wa,h=new W({getTheme:()=>n.effectiveTheme}),d=h.visualElements,u=new xi({view:n,extensionType:d.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:U.OccludeAndTransparent,isDecoration:!0}),g=je(d.heightPlaneAngleCutoff),_=new He({view:n,attached:!1,angleCutoff:g,isDecoration:!0}),m=Ce(1);o.push(y(()=>({lineShadowStyle:h.visualElements.lineGraphics.shadowStyle,pointShadowStyle:h.visualElements.pointGraphics.shadowStyle,alpha:m.value}),({lineShadowStyle:E,pointShadowStyle:G,alpha:X})=>{E.apply(t,X),G.apply(u,X)},$));const f=Ce(1);o.push(y(()=>({heightPlane:h.visualElements.heightPlane,alpha:f.value}),({heightPlane:E,alpha:G})=>E.apply(_,G),$));const M=()=>{if(l.update(i),!e.displaying||r&&(e.isDraped||!fi(a)||!a.geometry.hasZ))return t.laserlineEnabled=!1,u.attached=!1,void(_.attached=!1);t.laserlineEnabled=!0;const E=l.grabbingState&ct.XY?d.laserlineAlphaMultiplier:1;m.value=E;const G=l.grabbingState&ct.Z?d.laserlineAlphaMultiplier:1;f.value=G,Gs(u,l),Rs(i,t,_,l)};o.push(y(()=>h.visualElements.zVerticalLine,E=>E.apply(u),$)),o.push(e.on("changed",M),y(()=>e.displaying,M),t.events.on("attachment-origin-changed",M),Pt(u),Pt(_));const b=[],v=()=>{yi(b),b.length=0,i.forEachManipulator(E=>b.push(E.events.on("grab-changed",M))),i.forEachManipulator(E=>b.push(E.events.on("select-changed",M))),M()};return v(),o.push(i.onManipulatorsChanged(v),Ta(()=>B(b))),B(o)}function Gs(i,t){const e=t.numSelected===1?t.firstSelected:t.numSelected>1&&t.firstGrabbedXY!=null?t.firstGrabbedXY:null;e!=null?(i.setStartEndFromWorldDownAtLocation(e.renderLocation),i.attached=!0):i.attached=!1}function Rs(i,t,e,a){if(a.numSelected>0){ot(kt,0,0,0);let n=0;i.forEachManipulator((o,s)=>{s===D.TRANSLATE_XY&&o.selected&&o instanceof st&&(Et(kt,kt,o.renderLocation),n++)}),n>0?(e.heightManifoldTarget=It(kt,kt,1/n),e.attached=!0):e.attached=!1}else{const n=t.attachmentOrigin;n!=null&&i.view.renderCoordsHelper.toRenderCoords(n,kt)?(e.heightManifoldTarget=kt,e.attached=!0):e.attached=!1}}function fi(i){return i.geometry!=null&&(i.geometry.type==="polygon"||i.geometry.type==="polyline")}const kt=H();function $s(i){const{view:t,graphic:e}=i,a=new at({graphic:e}),n=[],o=Is(i,a,n);return Cs(i,a,n,o),n.push(t.trackGraphicState(a)),{visualElement:o,remove:()=>yi(n)}}function Cs(i,t,e,a){const{view:n,graphic:o}=i,s=new W({getTheme:()=>n.effectiveTheme}),r=new xi({view:n,extensionType:s.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:U.OccludeAndTransparent,isDecoration:!0});e.push(y(()=>s.visualElements.zVerticalLine,v=>v.apply(r),$));const l=new He({view:n,intersectsLineInfinite:!0,attached:!1,isDecoration:!0}),h=je(s.visualElements.heightPlaneAngleCutoff),d=new He({view:n,attached:!1,angleCutoff:h,isDecoration:!0}),u=k(i.graphic),g=Be.fromElevationInfo(u),_=u.mode==="on-the-ground"||!u.offset&&u.mode!=="absolute-height",m=new Wa,f=Ce(1);e.push(y(()=>({heightPlane:s.visualElements.heightPlane,alpha:f.value}),({heightPlane:v,alpha:E})=>v.apply(d,E),$));const M=Ce(1);e.push(y(()=>({shadowStyle:s.visualElements.pointGraphics.shadowStyle,alpha:M.value}),({shadowStyle:v,alpha:E})=>v.apply(l,E),$));const b=()=>{m.update(i);const v=Gi(o),E=_&&(t.isDraped||v==null||!v.hasZ);let G=!0;if(E||v==null)G=!1;else{const nt=vi(v,n.elevationProvider,g,n.renderCoordsHelper);ot(pt,v.x,v.y,nt),Vi(pt,v.spatialReference,pt,n.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(pt),l.intersectsWorldUpAtLocation=pt}const X=m.grabbingState&ct.Z?s.visualElements.laserlineAlphaMultiplier:1;f.value=X;const Y=Tn(Hs);!E&&t.displaying&&a.calculateMapBounds(Y)&&Vi(Dn(Y,pt),n.spatialReference,pt,n.renderCoordsHelper.spatialReference)?(d.heightManifoldTarget=pt,d.attached=!0):d.attached=!1;const T=m.grabbingState&ct.XY?s.visualElements.laserlineAlphaMultiplier:1;M.value=T;const K=G&&t.displaying&&!E;l.attached=K,r.attached=K};e.push(y(()=>[t.displaying,t.isDraped],b),t.on("changed",b)),i.forEachManipulator(v=>{e.push(v.events.on("grab-changed",b))}),e.push(Pt(l)),e.push(Pt(r)),e.push(Pt(d)),b()}function Is(i,t,e){const{view:a,graphic:n}=i,o=new wo({view:a,geometry:Gi(n),elevationInfo:k(n),isDecoration:!0});return Ps(i,o,t,e),e.push(Pt(o)),o}function Gi(i){const t=i.geometry;return t==null?null:t.type==="point"?t:t.type==="mesh"?t.anchor.clone():null}function Ps(i,t,e,a){const n=()=>{t.attached=e.displaying},o=new W({getTheme:()=>i.view.effectiveTheme});zs(i,t,e,a),o.visualElements.pointGraphics.outline.apply(t),a.push(y(()=>e.displaying,n,$))}function zs(i,t,e,a){const{view:n,graphic:o}=i;let s=null;const r=h=>{s!=null&&(s.remove(),s=null),e.isDraped&&h!=null&&(s=Ls(n,h,()=>{t.geometry=h}))},l=()=>{const h=Gi(o);r(h),t.geometry=h};a.push(e.on("changed",l),Ta(()=>s)),l()}function Ls(i,t,e){const a=i.elevationProvider.spatialReference;Gn(t,pt,a);const n=pt[0],o=pt[1];return i.elevationProvider.on("elevation-change",s=>{Da(s.extent,n,o)&&e()})}const pt=H(),Hs=An();function ii(i){switch(i.graphic.geometry.type){case"point":case"mesh":return $s(i);case"polygon":case"polyline":return As(i);default:return null}}const qa=128,mt=70,Vs=80,Ka=.02,ks=54,Us=100,Ja=Math.ceil(mt/3*2),Xt=160,li=.5,hi=24,Kt=9,Xs=Xt+30,na=Xt+53,Fs=60,Ns=23,Ys=5*Math.PI/12,Zs=1*Math.PI/3,oa=10,sa=.2,ra=30,la=53,ha=.2,pa=.3,Bs=200,js=3,Ws=1e6;let xe=class{constructor(){this._available=!0}set location(t){this._forEachManipulator3D(e=>e.location=t)}set elevationAlignedLocation(t){this._forEachManipulator3D(e=>e.elevationAlignedLocation=t)}set elevationInfo(t){this._forEachManipulator3D(e=>e.elevationInfo=t)}get renderLocation(){let t;return this._forEachManipulator3D(e=>{t||(t=e.renderLocation)}),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D(e=>e.available=t)}get hovering(){return this.someManipulator(t=>t.hovering)}get grabbing(){return this.someManipulator(t=>t.grabbing)}get dragging(){return this.someManipulator(t=>t.dragging)}hasManipulator(t){return this.someManipulator(e=>e===t)}someManipulator(t){let e=!1;return this.forEachManipulator(a=>{!e&&t(a)&&(e=!0)}),e}_forEachManipulator3D(t){this.forEachManipulator((e,a)=>{e instanceof st&&t(e,a)})}};function ai(i,t,e,a){const n=(o,s)=>t({action:o,graphic:i,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY});return e((o,s,r)=>(s.next(l=>(l.action==="start"&&n("start",l),l)).next(zo(i,a)).next(l=>{switch(l.action){case"start":case"update":(l.translationX||l.translationY||l.translationZ)&&n("update",l);break;case"end":n("end",l)}return l}),{steps:s,cancel:r=r.next(Lo(i)).next(l=>(n("end",{screenDeltaX:0,screenDeltaY:0}),l))}))}function Ye(i){if((i==null?void 0:i.axis)==null)return 1;const{mapStart:t,mapEnd:e,axis:a}=i,n=[e.x-t.x,e.y-t.y];return n[0]*a[0]+n[1]*a[1]>0?1:-1}let qs=class extends xe{constructor(t){super(),this._handles=new We,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=mt,this._updateAfterDrag=!1,this.events=new ft,this._tool=t.tool,this._view=t.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),t.radius!=null&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}set orthogonalAvailable(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}destroy(){this._handles=C(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:e}of this._arrowManipulatorInfos)t(e,D.TRANSLATE_XY)}createGraphicDragPipeline(t,e,a){const n=e.graphic,o=k(n),s=n.geometry.spatialReference;return ai(n,a,r=>this.createDragPipeline((l,h,d,u,g)=>({steps:h,cancel:d}=t(l,h,d,u,g),r(l,h,d)),o,s,n),this._view.state.viewingMode)}createDragPipeline(t,e,a,n){return B(this._arrowManipulatorInfos.map(({manipulator:o},s)=>dt(o,(r,l,h,d,u)=>{const g=l.next(_=>({..._,manipulatorType:D.TRANSLATE_XY})).next(_e(this._view,r.elevationAlignedLocation)).next(Oi(this._view,r.elevationAlignedLocation,e,a,n)).next(Ho(r.location,this.angle+(s+1)*Math.PI*.5)).next(se());t(r,g,h,d,u)})))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:e},a){const n=this._radius/mt,o=ks*n,s=o*Math.sqrt(3)/2,r=Ie(this._opaqueMaterial,s,o/2,o/2,Ka);Ga(r,ki(j.get(),ot(w.get(),0,-s/3,0))),t.renderObjects=[new x(r,O.Focused),new x(r.instantiate({material:this._transparentMaterial}),O.Unfocused)],t.radius=s/3*2*1.2;const l=Rn(j.get(),a*Math.PI/2),h=ki(j.get(),ot(w.get(),0,Us*n,0));Re(e,l,h)}_createManipulators(){for(let t=0;t<4;t++){const e=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(e)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,e=Ra(j.get(),t,q(0,0,1));if(e==null)return;const a=Pe(j.get(),ot(w.get(),this.displayScale,this.displayScale,this.displayScale)),n=Re(j.get(),a,e);for(const o of this._arrowManipulatorInfos){const s=Re(j.get(),n,o.transform);o.manipulator.modelTransform=s}}_createArrowManipulator(t){const e=new st({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:q(0,0,1)}}),a={manipulator:e,transform:qe()};return this._updateArrowManipulator(a,t),this._handles.add(e.events.on("drag",n=>{this._updateAfterDrag&&n.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(t=1){const e=new Mi({cullFace:bi.Back,renderOccluded:U.Transparent,isDecoration:!0});return this._handles.add(y(()=>it.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>{a[3]*=t,e.setParameters({color:a})},$)),e}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:t})=>t)}}},Ks=class{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const e=this._lastDragEvent.mapEnd,a=this._snap(this._lastDragEvent.screenEnd);if(a!=null){const n={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:t===!0?a:e,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(n)}}this._enabled=t}_snap(t){const e=this._view!=null?this._view.toMap(t,{exclude:[]}):null;return e!=null&&this._view!=null&&(e.z=$n(e,this._view,this._elevationInfo)),e}createDragEventPipelineStep(t,e){this._view=t,this._elevationInfo=e,this._lastDragEvent=null;const a=new Ya;return this._next=a,[n=>{if(this._lastDragEvent=n.action!=="end"?{...n}:null,this._enabled){const o=this._snap(n.screenEnd);return o!=null?{action:n.action,mapStart:n.mapStart,mapEnd:o,screenStart:n.screenStart,screenEnd:n.screenEnd}:null}return{action:n.action,mapStart:n.mapStart,mapEnd:n.mapEnd,screenStart:n.screenStart,screenEnd:n.screenEnd}},a]}};class Js extends xe{constructor(t){super(),this._handles=new We,this._snapToScene=new Ks,this._scale=1,this._radius=mt,this._view=t.view,this._tool=t.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),t.snapToScene!=null&&(this.snapToScene=t.snapToScene),t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles=C(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,D.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,e,a){const n=e.graphic,o=k(n),s=n.geometry.spatialReference;return ai(n,a,r=>this.createDragPipeline((l,h,d,u,g)=>({steps:h,cancel:d}=t(l,h,d,u,g),r(l,h,d)),o,s,n),this._view.state.viewingMode)}createDragPipeline(t,e,a,n){const o=this._view;return dt(this._manipulator,(s,r,l,h,d)=>{const u=r.next(_e(o,s.elevationAlignedLocation)).next(Oi(o,s.elevationAlignedLocation,e,a,n)).next(...this._snapToScene.createDragEventPipelineStep(o,e)).next(g=>({...g,manipulatorType:D.TRANSLATE_XY})).next(se());t(s,u,l,h,d)})}_updateManipulatorTransform(){const t=Pe(j.get(),ot(w.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new st({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:q(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=Cn(this._discMaterial,Ka,1,qa,q(0,0,1),q(0,0,0));t.transformation=Pe(qe(),q(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new x(t,O.Focused),new x(t.instantiate({material:this._discMaterialTransparent}),O.Unfocused)],this._manipulator.radius=Vs*(this._radius/mt)}_createMaterial(t=1){const e=new Mi({cullFace:bi.Back,renderOccluded:U.Transparent,isDecoration:!0});return this._handles.add(y(()=>it.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>{a[3]*=t,e.setParameters({color:a})},$)),e}get test(){return{discManipulator:this._manipulator}}}class Qs extends xe{constructor(t){super(),this._radius=mt,this.events=new ft,this._tool=t.tool,this._view=t.view;const e=new W({getTheme:()=>this._view.effectiveTheme});this._settings=e,t.radius!=null&&(this._radius=t.radius);const a=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:Ot(this._createDarkenedColor(a,1,.25),U.Occlude),materialFocused:Ot(this._createDarkenedColor(a,1,0),U.Occlude),materialOccludedUnfocused:Ot(this._createDarkenedColor(a,.7,0),e.zManipulator.renderOccluded),materialOccludedFocused:Ot(this._createDarkenedColor(a,.85,0),e.zManipulator.renderOccluded)},this._themeHandle=y(()=>this._view.effectiveTheme.accentColor,n=>{const o=this._createDarkenedColor(n,1,.25),s=this._createDarkenedColor(n,1,0),r=this._createDarkenedColor(n,.7,0),l=this._createDarkenedColor(n,.85,0),{materialUnfocused:h,materialFocused:d,materialOccludedUnfocused:u,materialOccludedFocused:g}=this._materials;h.setParameters({color:o}),d.setParameters({color:s}),u.setParameters({color:r}),g.setParameters({color:l})}),this._createManipulator(),this.forEachManipulator(n=>this._tool.manipulators.add(n))}destroy(){this._themeHandle=yt(this._themeHandle),this._manipulator.applyObjectTransform=er,this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){t(this._manipulator,D.TRANSLATE_Z)}createGraphicDragPipeline(t,e,a){const n=e.graphic.geometry.spatialReference;return ai(e.graphic,a,o=>this.createDragPipeline((s,r,l,h,d)=>({steps:r,cancel:l}=t(s,r,l,h,d),o(s,r,l)),n),this._view.state.viewingMode)}createDragPipeline(t,e){const a=this._view;return dt(this._manipulator,(n,o,s,r,l)=>{const h=o.next(d=>({...d,manipulatorType:D.TRANSLATE_Z})).next(Na(a,n.renderLocation,e)).next(se());t(n,h,s,r,l)})}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._settings,e=this._radius/mt,a=t.zManipulator.height*e,n=t.zManipulator.coneHeight*e,o=t.zManipulator.coneWidth*e,s=t.zManipulator.width*e,r=[q(0,0,0),q(0,0,a)],l=[q(0,0,0),q(0,0,a+n)],h=b=>{const v=qe();if(Hn(v,v,[0,0,a]),$a(v,v,Math.PI/2),b){const E=1+2*b/o;Ca(v,v,[E,E,E])}return v},d=h(0),{materialUnfocused:u,materialFocused:g,materialOccludedUnfocused:_,materialOccludedFocused:m}=this._materials,f=In(u,r,s/2,16,!1),M=Pn(u,n,o/2,16,!1);M.transformation=d,this._manipulator.renderObjects=[new x(M,O.Unfocused),new x(f,O.Unfocused),new x(M.instantiate({material:g}),O.Focused),new x(f.instantiate({material:g}),O.Focused),new x(M.instantiate({material:_}),O.Unfocused),new x(f.instantiate({material:_}),O.Unfocused),new x(M.instantiate({material:m}),O.Focused),new x(f.instantiate({material:m}),O.Focused)],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){const t=this._view,e=new st({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=a=>{const n=t.state.camera,o=ca;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,o);const s=zn(n.eye,o),r=n.computeRenderPixelSizeAtDist(s),l=z(Jt,o,n.eye);di(l,l);const h=tr;t.renderCoordsHelper.worldUpAtPosition(ca,h);const d=Math.abs(ze(l,h)),u=zt(Jt,l,h),g=zt(Jt,u,h),_=ui(d,.01,1),m=1-Math.sqrt(1-_*_)/_/n.fullWidth,f=this._settings,M=this._radius/mt,b=f.zManipulator.width*M;It(g,di(g,g),(1/m-1)*s+r*b),a[12]-=Jt[0],a[13]-=Jt[1],a[14]-=Jt[2]},this._manipulator=e,this._updateManipulator()}_createDarkenedColor(t,e,a){const n=Ln(t,a);return n.a*=e,it.toUnitRGBA(n)}get test(){return{manipulator:this._manipulator}}}const ca=H(),Jt=H(),tr=H(),er=()=>{};let Yt=class extends xe{constructor(t){super(),this._handles=new We,this._interactive=!0;const{tool:e,view:a,snapToScene:n,radius:o}=t;this._view=a,this.xyManipulation=new Js({tool:e,view:a,snapToScene:n,radius:o}),this.xyAxisManipulation=new qs({tool:e,view:a,radius:o}),this.zManipulation=new Qs({tool:e,view:a,radius:o}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(s=>this._handles.add(s.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,e,a){return B([this.xyManipulation.createGraphicDragPipeline((n,o,s,r,l)=>t(S.XY,n,o,s,r,l),e,a),this.xyAxisManipulation.createGraphicDragPipeline((n,o,s,r,l)=>t(S.XY_AXIS,n,o,s,r,l),e,a),this.zManipulation.createGraphicDragPipeline((n,o,s,r,l)=>t(S.Z,n,o,s,r,l),e,a)])}createDragPipeline(t,e,a,n){return B([this.xyManipulation.createDragPipeline((o,s,r,l,h)=>t(S.XY,o,s,r,l,h),e,a,n),this.xyAxisManipulation.createDragPipeline((o,s,r,l,h)=>t(S.XY_AXIS,o,s,r,l,h),e,a,n),this.zManipulation.createDragPipeline((o,s,r,l,h)=>t(S.Z,o,s,r,l,h),a)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator(e=>t(e,D.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(e=>t(e,D.TRANSLATE_XY)),this.zManipulation.forEachManipulator(e=>t(e,D.TRANSLATE_Z))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator(e=>e.focused)||this.xyAxisManipulation.someManipulator(e=>e.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,e=this.xyManipulation;if(Vn("esri-mobile"))return;const a=[];e.forEachManipulator(o=>a.push(o)),t.forEachManipulator(o=>a.push(o));const n=()=>{const o=[];this._xyAxisVisible||t.forEachManipulator(s=>o.push(s.disableDisplay())),this._handles.remove(da),this._handles.add(o,da)};for(const o of a)this._handles.add(o.events.on("focus-changed",n));this._view.inputManager&&this._handles.add(Zt(()=>{var o;return(o=this._view.inputManager)==null?void 0:o.latestPointerType},n)),n()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator(e=>{e.interactive=!t&&this._interactive||e.grabbing})}static radiusForSymbol(t){const e=t!=null&&t.type==="point-3d"&&t.symbolLayers;return e&&e.some(a=>a.type==="icon")?Ja:mt}};const da="disable-xy-axis-display";var S;(function(i){i[i.XY=0]="XY",i[i.XY_AXIS=1]="XY_AXIS",i[i.Z=2]="Z"})(S||(S={}));class Ri extends xe{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,D.TRANSLATE_XY)}createGraphicDragPipeline(t){return ai(this._graphicState.graphic,t,e=>this.createDragPipeline(e),this._view.state.viewingMode)}createDragPipeline(t){const e=this._view,a=this._graphicState.graphic,n=a.geometry!=null?a.geometry.spatialReference:null;return dt(this._manipulator,(o,s,r,l,h)=>{const d=s.next(Ro(h,e,a,n)).next(Qt()).next(se());t(o,d,r,l,h)})}_createManipulator(){const t=this._view,e=this._graphicState.graphic;this._manipulator=new Xo({graphic:e,view:t,selectable:!0,cursor:"move"})}}let ir=class{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}};class ar{constructor(t,e,a){this.dx=t,this.dy=e,this.allGraphics=a,this.type="graphic-move"}}class ua{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}const ut="manipulators";let vt=class extends ft.EventedMixin(Qe){constructor(i){super(i),this._infos=new Map,this.graphics=new kn,this.enableZ=!0,this.tooltipOptions=new Ht,this.type="move-3d",this._updatingHandles=new Si,this._moveManipulation=null,this._tooltip=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{view:i}=this;this.addHandles([this.graphics.on("change",e=>{e.removed.forEach(a=>this.removeHandles(a)),this._updateGraphicInfos(e),this._setupFastTransformUpdates(e.added),this._refreshManipulators()}),y(()=>this.tooltipOptions.enabled,e=>{this._tooltip=e?new we({view:i}):C(this._tooltip)},ae)]);const t=this.graphics.toArray();this._updateGraphicInfos({added:t,removed:[]}),this._setupFastTransformUpdates(t),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=C(this._tooltip),this._moveManipulation=C(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateGraphicInfos({added:i,removed:t}){var e;for(const a of i){if(Un(a)!==Ia.SUPPORTED)continue;const n=new nr(a),o=this.view.trackGraphicState(n.state);this._infos.set(n.graphic,{info:n,handle:o})}for(const a of t)(e=this._infos.get(a))==null||e.handle.remove(),this._infos.delete(a)}_setupFastTransformUpdates(i){for(const t of i){const{info:e}=this._infos.get(t);this.addHandles(Ti(e.state),t)}}_refreshManipulators(){if(this.removeHandles(ut),this._moveManipulation=C(this._moveManipulation),this.manipulators.removeAll(),this._infos.size===0)return;const i=Array.from(this._infos.values(),({info:t})=>t);this._createManipulators(i),this._createVisualElements(i),this._updateMoveManipulation(i)}_createManipulators(i){for(const t of i){const e=t.state;t.manipulationXY=new Ri({tool:this,view:this.view,graphicState:e}),t.manipulationXY.forEachManipulator(a=>this.addHandles([a.events.on("immediate-click",n=>{this.emit("immediate-click",{...n,graphic:e.graphic}),n.stopPropagation()}),a.events.on("grab-changed",({action:n})=>{const{tooltipOptions:o,_tooltip:s}=this;s!=null&&(n==="start"?(this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new Me({tooltipOptions:o})),s.info=this._translateGraphicTooltipInfo,s.info.tooltipOptions=o,s.info.distance=_t):s.clear())})],ut)),this.addHandles(t.manipulationXY.createDragPipeline((a,n,o,s)=>this._buildDragEventPipeline(i,S.XY,a,n,o,s)),ut)}this._createMoveManipulation(i)}_createMoveManipulation(i){const t=new Yt({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:i.length===1?Yt.radiusForSymbol(i[0].graphic.symbol):mt});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator(o=>{this.addHandles(o.events.on("immediate-click",s=>{t.zManipulation.hasManipulator(o)||this.graphics.length!==1||this.emit("immediate-click",{...s,graphic:this.graphics.at(0)}),s.stopPropagation()}),ut)});const e=o=>s=>{this.addHandles(s.events.on("focus-changed",({action:r})=>{const l=this._tooltip;l!=null&&(r==="focus"?this._updateMoveTooltip(i,o):l.clear())}),ut)};this._moveManipulation.xyManipulation.forEachManipulator(e(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(e(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(e(S.Z));const a=()=>this._updateMoveManipulation(i);for(const o of i)this.addHandles([o.state.on("changed",a),y(()=>o.state.displaying,a)],ut);const n=i[i.length-1];this.addHandles(n.state.on("changed",()=>this._updateMoveManipulationAngle(n)),ut),this.addHandles(t.createDragPipeline((o,s,r,l,h)=>this._buildDragEventPipeline(i,o,s,r,l,h),k(n.graphic),n.graphic.geometry.spatialReference,n.graphic),ut),this._updateMoveManipulationAngle(n)}_createVisualElements(i){for(const t of i){const e=t.graphic,a=ii({view:this.view,graphic:e,forEachManipulator:n=>{var o,s;(o=t.manipulationXY)==null||o.forEachManipulator(n),(s=this._moveManipulation)==null||s.forEachManipulator(n)},onManipulatorsChanged:()=>Z()});a!=null&&(t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof Bt&&this.addHandles([t.geometryRepresentation.events.on("attachment-origin-changed",()=>{t.state.isDraped||this._updateMoveManipulation(i)}),y(()=>t.state.isDraped,()=>this._updateMoveManipulation(i))],ut),this.addHandles(a,ut))}}_updateMoveManipulationAngle(i){this._moveManipulation&&(this._moveManipulation.angle=Di(i.graphic.geometry))}_updateMoveManipulation(i){const t=be(0,0,0,this.view.spatialReference);let e=0,a=!1;const n=this._moveManipulation;if(n){for(const o of i){if(!o.state.displaying)continue;const s=o.state.graphic;this.enableZ&&Nt(s)&&(a=!0);const r=o.geometryRepresentation instanceof Bt&&!o.state.isDraped?o.geometryRepresentation.attachmentOrigin:Ua(this.view,s);if(r!=null){const{x:l,y:h,z:d}=r;t.x+=l,t.y+=h,d&&(t.z??(t.z=0),t.z+=d),e++}}e>0?(t.x/=e,t.y/=e,t.z??(t.z=0),t.z/=e,n.location=t,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=a):n.available=!1}}_buildDragEventPipeline(i,t,e,a,n,o){const s=[],r=[];let l=null,h=null;const d=()=>{for(const u of s)u.dragging=!1;s.length=0,r.length=0,l=null,h=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(i.length===1&&t===S.XY){const u=i[0].graphic;({steps:a,cancel:n}=this._buildSnappingPipelineSteps(u,k(u),a,n,o))}return n=n.next(u=>h==null?void 0:h(u)).next(()=>(this.emit("graphic-move-stop",new ua(r)),this.destroyed||d(),null)),{steps:a=a.next(u=>{var g,_;if(u.action==="start"){s.length=0,r.length=0;for(const m of i)m.dragging||!((g=m.manipulationXY)!=null&&g.hasManipulator(e))&&((_=m.manipulationXY)!=null&&_.grabbing)||(s.push(m),r.push(m.graphic),m.dragging=!0);if(r.length!==0&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=Vo(r,this.view.state.viewingMode),h=ko(r),this.emit("graphic-move-start",new ir(r)),this.destroyed))return null}return r.length!==0?u:null}).next(u=>l==null?void 0:l(u)).next(u=>(this._updateMoveTooltip(i,t,u),u)).next(u=>{switch(u.action){case"start":case"update":if(u.translationX||u.translationY||u.translationZ){const g=this.view.toScreen(u.mapStart),_=this.view.toScreen(u.mapEnd),m=_.x-g.x,f=_.y-g.y;if(this.emit("graphic-move",new ar(m,f,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new ua(r)),this.destroyed)return null;d()}return null}),cancel:n}}_updateMoveTooltip(i,t,e){const{tooltipOptions:a,_tooltip:n}=this;if(n==null)return;n.clear();const o=i.length===0?"absolute-height":i[0].state.isDraped?"on-the-ground":"absolute-height";switch(t){case S.XY:n.info=this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new Me({tooltipOptions:a})),this._updateMoveTooltipDistance(n.info,e,(s,r)=>At(s,r,o));break;case S.XY_AXIS:n.info=this._translateGraphicXYTooltipInfo??(this._translateGraphicXYTooltipInfo=new Ai({tooltipOptions:a})),this._updateMoveTooltipDistance(n.info,e,(s,r)=>{const l=At(s,r,o);return Ve(l,Ye(e))});break;case S.Z:n.info=this._translateGraphicZTooltipInfo??(this._translateGraphicZTooltipInfo=new ei({tooltipOptions:a})),this._updateMoveTooltipDistance(n.info,e,Xe)}n.info.tooltipOptions=a}_updateMoveTooltipDistance(i,t,e){if(t!=null&&t.action!=="end"){const{mapStart:a,mapEnd:n}=t,o=e(a,n);i.distance=o??_t}else i.distance=_t}_buildSnappingPipelineSteps(i,t,e,a,n){const o=i.geometry;if(o==null||o.type!=="point"&&o.type!=="mesh")return{steps:e,cancel:a};const s=(o.type==="point"?o:o.anchor).clone(),r=new ke({elevationInfo:t,pointer:n,editGeometryOperations:ti.fromGeometry(s,this.view.state.viewingMode),visualizer:new ve,excludeFeature:i}),l=this.snappingManager,{snappingStep:h,cancelSnapping:d}=Ue({snappingContext:r,snappingManager:l,updatingHandles:this._updatingHandles});return a=a.next(d),{steps:e=e.next(u=>(s.z=Xn(this.view,s,k(i),{mode:"absolute-height",offset:0}),{...u,snapOrigin:r.coordinateHelper.pointToVector(s)})).next(...h),cancel:a}}get test(){return{tooltip:this._tooltip}}};p([c({constructOnly:!0,nonNullable:!0})],vt.prototype,"view",void 0),p([c()],vt.prototype,"graphics",void 0),p([c({constructOnly:!0,nonNullable:!0})],vt.prototype,"enableZ",void 0),p([c({constructOnly:!0,type:Ht})],vt.prototype,"tooltipOptions",void 0),p([c({constructOnly:!0})],vt.prototype,"snappingManager",void 0),p([c()],vt.prototype,"type",void 0),p([c()],vt.prototype,"updating",null),vt=p([V("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],vt);class nr{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new at({graphic:t})}get graphic(){return this.state.graphic}}function ga(i,t,e){const a=e.mode==="on-the-ground"?Ji.XY:Ji.XYZ;return new Fo(i,a,t,0)}function _a(i,t,e){const a=H();if(!i.renderCoordsHelper.toRenderCoords(t,a))return null;const n=ma(i,t,Se(e.plane)),o=ma(i,t,e.edgeDirection);if(n==null||o==null)return null;const s=zt(H(),n,o);return Pa(a,s,wi())}function ma(i,t,e){const a=be(t.x+e[0],t.y+e[1],t.z+e[2],t.spatialReference),n=H(),o=H();return i.renderCoordsHelper.toRenderCoords(t,n)&&i.renderCoordsHelper.toRenderCoords(a,o)?za(o,n,o):null}function or(i,t,e){const a=Se(i),n=za(H(),t,e),o=zt(H(),n,a),s=zt(H(),n,o);return Fn(n[0],n[1],n[2],0,o[0],o[1],o[2],0,s[0],s[1],s[2],0,0,0,0,1)}function sr(i,t,e){const a=e.projectToRenderScreen(i,Ui()),n=e.projectToRenderScreen(t,Ui());return a!=null&&n!=null?Nn(z(a,a,n)):0}let Ct=class extends Ke{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=_t,this.area=null,this.totalLength=null}};p([c()],Ct.prototype,"type",void 0),p([c()],Ct.prototype,"distance",void 0),p([c()],Ct.prototype,"area",void 0),p([c()],Ct.prototype,"totalLength",void 0),Ct=p([V("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],Ct);let P=class extends ft.EventedMixin(Lt){constructor(t){super(t),this._selectedIndex=0,this._manipulatorHandles=new We,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=R.NONE,this._updatingHandles=new Si,this._recreatingManipulators=!1,this._settings=new W({getTheme:()=>this.view.effectiveTheme}),this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null,this._translateVertexTooltipInfo=null,this._translateVertexXYTooltipInfo=null,this._translateVertexZTooltipInfo=null,this._edgeOffsetTooltipInfo=null,this.outputGeometry=null,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:t,view:e}=this,a=this._settings.manipulators,n=a.vertex;this._vertexManipulatorMaterial=Ot(I(n.color),n.renderOccluded),this._vertexManipulatorOutlineMaterial=he(I(n.outlineColor),n.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=he(I(n.hoverOutlineColor),n.renderOccluded);const o=a.edge;this._edgeManipulatorMaterial=Ot(I(o.color),o.renderOccluded),this._edgeManipulatorOutlineMaterial=he(I(o.outlineColor),o.renderOccluded);const s=a.edgeOffset;this._edgeOffsetManipulatorMaterial=Ot(I(s.color),s.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=Ot(I(s.hoverColor),s.renderOccluded,!1);const r=a.selected;this._selectedManipulatorMaterial=Ot(I(r.color),r.renderOccluded),this._selectedManipulatorOutlineMaterial=he(I(r.outlineColor),r.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=he(I(r.hoverOutlineColor),r.renderOccluded);const l=this._graphicState=new at({graphic:t});this._tooltip=new we({view:e}),this.addHandles([y(()=>{const h=this._settings.manipulators;return{vertexSettings:h.vertex,edgeSettings:h.edge,edgeOffsetSettings:h.edgeOffset,selectedSettings:h.selected}},({vertexSettings:h,edgeSettings:d,edgeOffsetSettings:u,selectedSettings:g})=>{h.applyColor(this._vertexManipulatorMaterial),h.applyOutline(this._vertexManipulatorOutlineMaterial),h.applyHoverOutline(this._vertexManipulatorHoverOutlineMaterial),d.applyColor(this._edgeManipulatorMaterial),d.applyOutline(this._edgeManipulatorOutlineMaterial),u.applyColor(this._edgeOffsetManipulatorMaterial),u.applyHover(this._edgeOffsetManipulatorHoverMaterial),g.applyColor(this._selectedManipulatorMaterial),g.applyOutline(this._selectedManipulatorOutlineMaterial),g.applyHoverOutline(this._selectedManipulatorHoverOutlineMaterial)}),y(()=>l.displaying,h=>{for(const d of this._manipulatorInfos)d.manipulator.available=h}),y(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:h,enabled:d,edgeOffsetEnabled:u})=>{h!=null&&(h.visible=d,h.edgeDistance=u?"far":"default")},$),Zt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),$),this.view.trackGraphicState(l)])}destroy(){this._segmentLabels=C(this._segmentLabels),this._tooltip=C(this._tooltip),this._removeManipulators(),this._updatingHandles.destroy()}get inputGeometry(){return this._editGeometryOperations!=null?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this._updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}get _accentColor(){return this.view.effectiveTheme.accentColor}removeSelectedVertices(){const t=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.type==="vertex");this._removeVertices(t)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=C(this._moveManipulation),this._graphicMoveManipulation=C(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(t){if(this._editGeometryOperations==null)return;const e=k(this.graphic);for(const a of this._editGeometryOperations.data.components){const n=t==null?void 0:t.byComponentIndex.get(a.index);for(const o of a.vertices){const s=n==null?void 0:n.has(o.index);this._createVertexOrEdgeManipulator(o,e,s)}for(const o of a.edges)this._createVertexOrEdgeManipulator(o,e)}this._createGraphicMoveManipulation(),this._createMoveManipulation(e),this._createVisualElements()}get canRedo(){return this._editGeometryOperations!=null&&this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations!=null&&this._editGeometryOperations.canUndo}redo(){if(this._editGeometryOperations==null)return null;const t=this._editGeometryOperations.redo();return t!=null&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(this._editGeometryOperations==null)return null;this.emit("undo");const t=this._editGeometryOperations.undo();return t!=null&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._recreatingManipulators||(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._createManipulators(),this._recreatingManipulators=!1)}_recreateEditGeometryAndManipulators(t){const e={byComponentIndex:new Map};if(t!=null&&this.inputGeometry!=null&&Yn(t,this.inputGeometry)){for(const n of this._manipulatorInfos)if(n.type==="vertex"&&n.manipulator.selected){const{index:o,component:{index:s}}=n.handle,{byComponentIndex:r}=e,l=r.get(s)||new Set;l.add(o),r.set(s,l)}}if(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._editGeometryOperations=C(this._editGeometryOperations),this._segmentLabels=C(this._segmentLabels),t==null)return void(this._recreatingManipulators=!1);const a=t.type==="mesh"?t.anchor:t;this._editGeometryOperations=ti.fromGeometry(a,this.view.state.viewingMode),this._createManipulators(e),this._segmentLabels=new Fe({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:k(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}),this._recreatingManipulators=!1}_perGraphicManipulatorDragAction(t,e){if(e.action==="end")return e;let a=0;const n=[],o=this._manipulatorInfos.some(r=>r.type==="vertex"&&r.manipulator.selected),s=t===te.SELECTED_OR_ALL&&o;for(const r of this._manipulatorInfos)r.type==="vertex"&&(r.manipulator.grabbing||s&&!r.manipulator.selected||n.push(r),a++);if(n.length===0)return e;if(this._moveVertices(n,e),n.length===a){if(this._updateEventState(R.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(R.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){return this._manipulatorInfos.reduce((t,e)=>e.type==="vertex"&&e.manipulator.selected?t+1:t,0)>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(R.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:a,mapDeltaZ:n}=t;if(!e&&!a&&!n)return;const o=[];for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected&&!s.manipulator.grabbing||s===t.info)&&o.push(s);this._moveVertices(o,t,Tt.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case R.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case R.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case R.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case R.MOVING:switch(this._reshapeEventState){case R.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case R.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case R.RESHAPING:switch(this._reshapeEventState){case R.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case R.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulation(){const{tool:t,view:e}=this,a=this._graphicState;if(this._graphicMoveManipulation=new Ri({tool:t,view:e,graphicState:a}),this.enableMoveGraphic){let n=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((o,s,r)=>{s.next(l=>this._trackNumDragging(l)).next(l=>(l.action==="start"&&(n=this._editGeometryOperations.createUndoGroup()),l)).next(l=>this._perGraphicManipulatorDragAction(te.ALL,l)).next(l=>(this._updateTranslateGraphicTooltip(S.XY,l),l)).next(l=>{l.action==="end"&&(this._tooltip.clear(),n=yt(n))}),r.next(()=>this._onDragCancel(!0,()=>n=yt(n)))})),this._graphicMoveManipulation.forEachManipulator(o=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(o,!1)))}else this._graphicMoveManipulation.forEachManipulator(n=>{n.grabbable=!1,n.cursor=null});this._graphicMoveManipulation.forEachManipulator(n=>this._manipulatorHandles.add(n.events.on("immediate-click",o=>{this._manipulatorInfos.some(s=>s.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...o,graphic:this.graphic}),o.stopPropagation()})))}_createMoveManipulation(t){const{graphic:e,tool:a,view:n}=this,o=this._graphicState;this._moveManipulation=new Yt({tool:a,view:n,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Nt(e),snapToScene:!1,radius:Yt.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator(l=>this.addHandles([l.events.on("immediate-click",h=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(d=>d.manipulator.selected)||this.emit("immediate-click",{...h,graphic:e}),h.stopPropagation()}),this._watchAndUpdateGrabState(l,!1)]));const s=l=>h=>{this.addHandles(h.events.on("focus-changed",({action:d})=>{d==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(l):this._tooltip.clear()}))};this._moveManipulation.xyManipulation.forEachManipulator(s(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(s(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(s(S.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const r=e.geometry.spatialReference;this.addHandles([this._moveManipulation.createDragPipeline((l,h,d,u,g)=>{const{snappingStep:_,cancelSnapping:m}=Ue({predicate:f=>!!f.info,snappingManager:a.snappingManager,snappingContext:new ke({editGeometryOperations:this._editGeometryOperations,elevationInfo:t,pointer:g,excludeFeature:e,visualizer:new ve}),updatingHandles:this._updatingHandles,useZ:!1});return u=u.next(f=>(this._onDragCancel(),f)).next(m),{steps:d=d.next(f=>this._trackNumDragging(f)).next(f=>{const M=this._manipulatorInfos.filter(b=>b.type==="vertex"&&b.manipulator.selected);return f.manipulatorType===D.TRANSLATE_XY&&M.length===1?{...f,info:M[0],snapOrigin:M[0].handle.pos}:f}).next(Ki(this.view,t,e)).next(..._).next(Qt()).next(f=>this._perGraphicManipulatorDragAction(te.SELECTED_OR_ALL,f)).next(f=>(this._updateTranslateTooltip(l,f),f)),cancel:u}},t,r,e),y(()=>o.displaying,()=>this._updateMoveManipulationPosition(),$),o.on("changed",()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()}),y(()=>o.isDraped,l=>{this._updateMoveManipulationPosition();const h="align-move-manipulation";l?this.addHandles(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),h):this.removeHandles(h)},$)])}_createVisualElements(){const{graphic:t,view:e}=this,a=ii({view:e,graphic:t,forEachManipulator:n=>{if(!this.destroyed&&!this._recreatingManipulators){this._graphicMoveManipulation.forEachManipulator(n),this._moveManipulation.forEachManipulator(n);for(const o of this._manipulatorInfos)n(o.manipulator,D.TRANSLATE_XY)}},onManipulatorsChanged:n=>this.on("manipulators-changed",n)});a!=null&&(this._outlineVisualElement=a.visualElement instanceof Bt?a.visualElement:null),this._outlineVisualElement!=null&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._manipulatorHandles.add(a)}_createEdgeOffsetManipulator(t,e=k(this.graphic)){var m,f;const a=this._settings.manipulators.edgeOffset,n=a.size/2,o=n+a.collisionPadding,s=n/o,r=s*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside==null&&(this._edgeOffsetManipulatorGeometryInside=Ie(this._edgeOffsetManipulatorMaterial,r,s/2,s/2,a.height,a.offset)),this._edgeOffsetManipulatorGeometryOutside==null&&(this._edgeOffsetManipulatorGeometryOutside=Ie(this._edgeOffsetManipulatorMaterial,-r,s/2,s/2,a.height,-a.offset));const l=[new x(this._edgeOffsetManipulatorGeometryInside.instantiate(),O.Unfocused),new x(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),O.Focused),new x(this._edgeOffsetManipulatorGeometryOutside.instantiate(),O.Unfocused),new x(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),O.Focused)],h=new st({view:this.view,renderObjects:l,elevationInfo:e.mode!=="on-the-ground"||Xi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:o,available:!(!this.graphic.visible||!((m=this.graphic.layer)!=null&&m.visible)),collisionType:{type:"disc",direction:q(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),d=new st({view:this.view,worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!((f=this.graphic.layer)!=null&&f.visible)),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),u={manipulator:h,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:d,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(u,a.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(u);const g=[];for(const M of[u.handle.leftVertex,u.handle.rightVertex]){const b=this._getManipulatorInfoFromHandle(M);b!=null&&g.push(b.manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(u)))}u.locationUpdateHandle=B(g),this._manipulatorHandles.add(u.locationUpdateHandle,h),this._manipulatorHandles.add([this._watchAndUpdateGrabState(h,!0),this._watchAndUpdateGrabState(d,!0)],h),this._manipulatorHandles.add(dt(h,this._createEdgeOffsetPipeline(u,e)),h),this._manipulatorHandles.add(dt(d,(M,b,v,E)=>{if(E==="touch")this._createEdgeOffsetPipeline(u,e)(M,b,v);else if(this.enableMoveGraphic){const G=this.graphic,X=G.geometry!=null?G.geometry.spatialReference:null;b.next(Y=>this._trackNumDragging(Y)).next(_e(this.view,M.elevationAlignedLocation)).next(Oi(this.view,M.elevationAlignedLocation,e,X,G)).next(se()).next(Qt()).next(Y=>this._perGraphicManipulatorDragAction(te.ALL,Y)).next(Y=>(this._updateTranslateGraphicTooltip(S.XY,Y),Y)).next(Y=>{Y.action==="end"&&this._tooltip.clear()}),v.next(()=>this._onDragCancel(!M.metadata.deleting))}}),h);const _=M=>{this._manipulatorInfos.some(b=>b.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...M,graphic:this.graphic}),M.stopPropagation()};return this._manipulatorHandles.add([h.events.on("immediate-click",_),d.events.on("immediate-click",_),h.events.on("focus-changed",({action:M})=>{const{_tooltipOptions:b,_tooltip:v}=this;M==="focus"&&b.enabled?(v.info=this._edgeOffsetTooltipInfo??(this._edgeOffsetTooltipInfo=new Ct({tooltipOptions:b})),v.info.distance=_t,v.info.tooltipOptions=b,this._updateTooltipAreaOrTotalLength(v.info)):v.clear()})],h),this._manipulatorInfos.push(u),this.manipulators.add(h),this.manipulators.add(d),this.emit("manipulators-changed"),u}_autoHideEdgeOffsetManipulator(t,e){const a=t.manipulator,n=t.edgeManipulator,o=()=>{t.visibilityHandle=yt(t.visibilityHandle);const s=this._getManipulatorInfoFromHandle(t.handle.leftVertex),r=this._getManipulatorInfoFromHandle(t.handle.rightVertex),l=s!=null&&r!=null&&sr(s.manipulator.renderLocation,r.manipulator.renderLocation,this.view.state.camera)<e;(!a.focused&&!n.focused||l)&&(a.grabbable=!l,n.grabbable=!l,t.visibilityHandle=B([a.disableDisplay(),Z(()=>{a.grabbable=!0,n.grabbable=this.enableMoveGraphic})]))};this._manipulatorHandles.add([a.events.on("focus-changed",o),n.events.on("focus-changed",o),Z(()=>{yt(t.visibilityHandle),n.metadata.deleting=!0,this.manipulators.remove(n)})],a),o()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const{coordinateHelper:e}=this._editGeometryOperations.data,a=_a(this.view,t.manipulator.elevationAlignedLocation,ga(e,t.handle,t.manipulator.elevationInfo)),n=this._getManipulatorInfoFromHandle(t.handle.leftVertex),o=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(n==null||o==null)return;const s=n.manipulator.renderLocation,r=o.manipulator.renderLocation,l=a!=null?or(a,s,r):Zn;t.manipulator.modelTransform=l,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=l;const h=ne(z(Te,s,r))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-h,0,0],[h,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(a,n,o)=>{this._clearSelection();const{step:s,cleanup:r}=this._initializeEdgeOffset(t,e);n.next(l=>this._trackNumDragging(l)).next(_e(this.view,a.elevationAlignedLocation)).next(s).next($o(this.view)).next(Co(this.view,this._editGeometryOperations.data.spatialReference)).next(Qt()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next(l=>{l.action==="end"&&r()}),o.next(()=>{a.metadata.deleting||(r(),this._onDragCancel())})}}_initializeEdgeOffset(t,e){const{view:a}=this,n=this._editGeometryOperations,o=ga(n.data.coordinateHelper,t.handle,e),s=n.createUndoGroup(),r=_a(a,t.manipulator.elevationAlignedLocation,o);if(o.requiresSplitEdgeLeft){const m=this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge);m!=null&&this._splitEdgeManipulator(m,1)}if(o.requiresSplitEdgeRight){const m=this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge);m!=null&&this._splitEdgeManipulator(m,0)}const l=()=>new qn({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:n.data.spatialReference}),h=this._settings,d=new Bt({view:a,isDraped:this._graphicState.isDraped,geometry:l(),elevationInfo:t.elevationInfo,width:h.visualElements.lineGraphics.outline.width,attached:!1,isDecoration:!0});let u;const g=()=>{this._cleanEdgeOffsetCollapsedEdges(t),u=yt(u)},_=this.on("undo",g);return u=B([y(()=>I(this._accentColor),m=>d.color=m,$),Pt(d),y(()=>this._graphicState.isDraped,m=>d.isDraped=m),this._graphicState.on("changed",()=>d.geometry=l()),s,_]),d.attached=!0,{step:m=>o==null||r==null?(g(),null):{...m,operation:o,plane:r},cleanup:g}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||e.operation==null)return e;this._updateEventState(R.RESHAPING);const{mapDeltaX:a,mapDeltaY:n,mapDeltaZ:o}=e;return(a||n||o)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:a}=t;return e==null||a==null?t:(t.action==="start"&&e.selectArrowFromStartPoint(a),{...t,signedDistance:e.signedDistanceToPoint(a)})}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:a,operation:n}=t,{_tooltip:o,_tooltipOptions:s}=this;return s.enabled&&a!=null?(o.info=this._edgeOffsetTooltipInfo??(this._edgeOffsetTooltipInfo=new Ct({tooltipOptions:s})),o.info.tooltipOptions=s,o.info.distance=t.action==="end"?_t:rr(this._graphicState.isDraped,a*n.selectedArrow,e,n.plane,this._editGeometryOperations.data.coordinateHelper),this._updateTooltipAreaOrTotalLength(o.info),t):(o.clear(),t)}}_cleanEdgeOffsetCollapsedEdges(t){var l,h;const e=(l=t.handle.leftVertex.leftEdge)==null?void 0:l.leftVertex,a=t.handle.leftVertex,n=(h=t.handle.rightVertex.rightEdge)==null?void 0:h.rightVertex,o=t.handle.rightVertex,s=this._editGeometryOperations.data.coordinateHelper,r=[];if(e&&s.distance(e.pos,a.pos)<pi){const d=this._getManipulatorInfoFromHandle(a);d!=null&&r.push(d)}if(s.distance(a.pos,o.pos)<pi||n&&s.distance(n.pos,o.pos)<pi){const d=this._getManipulatorInfoFromHandle(o);d!=null&&r.push(d)}r.length&&this._removeVertices(r)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,a=e+t.collisionPadding;return{size:e/a,outlineSize:(e+t.outlineSize)/a}}_createVertexOrEdgeManipulator(t,e=k(this.graphic),a=!1){var g;const{view:n}=this,o=this._settings;if(t.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(this._vertexManipulatorGeometry==null||this._vertexManipulatorOutlineGeometry==null){const{size:_,outlineSize:m}=this._computeVertexManipulatorSizeAndOutline(o.manipulators.vertex);this._vertexManipulatorGeometry=Oe(this._vertexManipulatorMaterial,_,16,16),this._vertexManipulatorOutlineGeometry=Oe(this._vertexManipulatorOutlineMaterial,m,16,16)}if(this._edgeManipulatorGeometry==null||this._edgeManipulatorOutlineGeometry==null){const{size:_,outlineSize:m}=this._computeVertexManipulatorSizeAndOutline(o.manipulators.edge);this._edgeManipulatorGeometry=Oe(this._edgeManipulatorMaterial,_,16,16),this._edgeManipulatorOutlineGeometry=Oe(this._edgeManipulatorOutlineMaterial,m,16,16)}const{geometry:s}=this.graphic,r=s==null?void 0:s.type,l=r==="point"||r==="mesh"?[]:[new x(this._vertexManipulatorGeometry.instantiate(),ht.Vertex|O.Unselected),new x(this._vertexManipulatorOutlineGeometry.instantiate(),ht.Vertex|O.Unfocused|O.Unselected),new x(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),ht.Vertex|O.Focused|O.Unselected),new x(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),O.Selected),new x(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),O.Selected|O.Unfocused),new x(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),O.Selected|O.Focused)];this.enableMidpoints&&l.push(new x(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),ht.Edge|O.Focused|O.Unselected),new x(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),ht.Edge|O.Focused|O.Unselected),new x(this._edgeManipulatorGeometry.instantiate(),ht.Edge|O.Unfocused|O.Unselected),new x(this._edgeManipulatorOutlineGeometry.instantiate(),ht.Edge|O.Unfocused|O.Unselected));const h=new st({view:n,renderObjects:l,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!((g=this.graphic.layer)!=null&&g.visible)),metadata:{deleting:!1}});h.selected=a,this._setTypeSpecificManipulatorSettings(h,t,e);const d=t.type==="edge"?{manipulator:h,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:h,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(d),this.manipulators.add(h),this._updateManipulatorPosition(d),d.type==="edge"){const _=[];for(const m of[d.handle.leftVertex,d.handle.rightVertex]){const f=this._getManipulatorInfoFromHandle(m);f!=null&&_.push(f.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(d)))}d.locationUpdateHandle=B(_),this._manipulatorHandles.add(d.locationUpdateHandle,h)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(h,!0),h);const u=dt(h,(_,m,f,M)=>{let b=null;const{snappingStep:v,cancelSnapping:E}=Ue({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new ke({editGeometryOperations:this._editGeometryOperations,elevationInfo:e,pointer:M,excludeFeature:this.graphic,visualizer:new ve}),updatingHandles:this._updatingHandles,useZ:!1});f=f.next(G=>(this._onDragCancel(!_.metadata.deleting,()=>b=yt(b)),G)).next(E),m.next(G=>this._trackNumDragging(G)).next(G=>{if(G.action==="start"&&(b=this._editGeometryOperations.createUndoGroup()),d.type==="edge"){const X=this._splitEdgeManipulator(d);return{...G,info:X,snapOrigin:X.handle.pos}}return{...G,info:d,snapOrigin:d.handle.pos}}).next(_e(this.view,_.elevationAlignedLocation)).next(Io(this.view,this.graphic,_.elevationAlignedLocation,_.location.spatialReference,this.graphic)).next(Ki(this.view,e,this.graphic)).next(...v).next(Qt()).next(G=>{this._perVertexManipulatorDragAction(G),G.action==="end"&&(b=yt(b)),this._updateTranslateVertexTooltip(_,S.XY,G)})});return this._manipulatorHandles.add([u,h.events.on("immediate-click",_=>this._manipulatorClickCallback(_,d)),h.events.on("select-changed",()=>{d.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),h.events.on("focus-changed",({action:_})=>{_==="focus"&&d.type!=="edge"?this._updateTranslateVertexTooltip(h,S.XY):this._tooltip.clear()})],h),this.emit("manipulators-changed"),d}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_onDragCancel(t=!0,e){switch(this._numDragging--,t&&(this.undo(),this.outputGeometry=this._editGeometryOperations!=null?this._editGeometryOperations.data.geometry:null),this.tool.snappingManager!=null&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case R.NONE:break;case R.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case R.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(R.NONE)}_setTypeSpecificManipulatorSettings(t,e,a){const{graphic:n}=this,o=this._settings;switch(e.type){case"vertex":{t.state=ht.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2;const{size:s,collisionPadding:r}=o.manipulators.vertex;t.radius=s/2+r,t.elevationInfo=a;const{geometry:l}=n,h=l==null?void 0:l.type;t.interactive=h!=null&&h!=="point"&&h!=="mesh";break}case"edge":{t.state=ht.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1;const{size:s,collisionPadding:r}=o.manipulators.edge;t.radius=s/2+r,t.elevationInfo=a.mode!=="on-the-ground"||Xi(n.symbol)?{mode:"absolute-height",offset:0}:a;break}}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",a=>this._onGrabStateChanged(t,e,a.action,a.pointerType))}_onGrabStateChanged(t,e,a,n="mouse"){if(!this._recreatingManipulators){if(a==="start")e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(R.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(n!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(o=>{const{manipulator:s}=o,{geometry:r}=this.graphic,l=r==null?void 0:r.type;s.interactive=s.grabbing||!this._numGrabbing&&l!=null&&l!=="point"&&l!=="mesh","edgeManipulator"in o&&(o.edgeManipulator.interactive=o.edgeManipulator.grabbing||!this._numGrabbing)}),this._graphicMoveManipulation.forEachManipulator(o=>{o.interactive=o.grabbing||!this._numGrabbing}))}}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){t!=null&&(t.manipulator.metadata.deleting=!0,this.manipulators.remove(t.manipulator),this._manipulatorHandles.remove(t.manipulator),Bn(this._manipulatorInfos,t),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t){for(const e of this._manipulatorInfos)if(t===e.handle)return e}return null}_updateManipulatorPosition(t){if(t==null)return;const e=this._editGeometryOperations;if(t.type==="vertex")t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,ce),t.manipulator.grabbing&&this._vertexLaserLineVisualElement!=null&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if(t.type==="edge"){const a=this._getManipulatorInfoFromHandle(t.handle.leftVertex),n=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(a==null||n==null)return;const o=a.manipulator,s=n.manipulator;if(t.manipulator.elevationInfo!=null&&t.manipulator.elevationInfo.mode==="on-the-ground"){const r=o.location,l=s.location,h=.5,d=r.x+h*(l.x-r.x),u=r.y+h*(l.y-r.y),g=r.hasZ&&l.hasZ?0:void 0;t.manipulator.location=be(d,u,g,e.data.spatialReference)}else Ut(Te,o.renderLocation,s.renderLocation,.5),t.manipulator.renderLocation=Te}}_splitEdgeManipulator(t,e=.5){const a=this._editGeometryOperations,n=a.splitEdge(t.handle,e).createdVertex;t.locationUpdateHandle=yt(t.locationUpdateHandle);const o=k(this.graphic);let s;this.enableEdgeOffset?(this._removeManipulator(t),s=this._createVertexOrEdgeManipulator(n)):(s=t,s.handle=n,s.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,o)),n.leftEdge&&this._createVertexOrEdgeManipulator(n.leftEdge),n.rightEdge&&this._createVertexOrEdgeManipulator(n.rightEdge),this.outputGeometry=a.data.geometry,this._updateManipulatorPosition(s),this.enableEdgeOffset||this._updateTranslateVertexTooltip(s.manipulator,S.XY),this._updateSelection(t.manipulator);const r=this._updateEventState(R.RESHAPING),l=a.data.coordinateHelper.vectorToArray(s.handle.pos),h=a.data.components.indexOf(n.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:l,componentIndex:h,vertexIndex:n.index}],added:l}),r&&this._updateEventState(R.NONE),s}_updateMoveManipulationPosition(){const t=ot(Te,0,0,0);let e=0,a=!1,n=null,o=null;for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected?(e++,Et(t,t,s.manipulator.renderLocation),n==null||s.selectedIndex>n.selectedIndex?(o=n,n=s):(o==null||s.selectedIndex>o.selectedIndex)&&(o=s)):a=!0);if(e===0){const s=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s,this._moveManipulation.zManipulation.available=s&&this.enableZShape&&Nt(this.graphic),this._moveManipulation.angle=Di(this.graphic.geometry),this._moveManipulation.radius=Yt.radiusForSymbol(this.graphic.symbol)}else{const s=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.zManipulation.available=s&&this.enableZVertex&&Nt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s&&e!==1;let r=0;if(n!=null){const l=n.handle.pos,h=o!=null?o.handle.pos:n.handle.leftEdge&&n.handle.leftEdge.leftVertex?n.handle.leftEdge.leftVertex.pos:null,d=o==null&&n.handle.rightEdge&&n.handle.rightEdge.rightVertex?n.handle.rightEdge.rightVertex.pos:null;h&&d?this._moveManipulation.xyAxisManipulation.available=!1:h?r=fa(h,l):d&&(r=fa(l,d))}this._moveManipulation.angle=r,this._moveManipulation.radius=Ja}e!==0&&a?(It(t,t,1/e),ce.spatialReference=this._editGeometryOperations.data.spatialReference,ce.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,ce),this._moveManipulation.elevationAlignedLocation=ce):this._outlineVisualElement==null||this._graphicState.isDraped||this._outlineVisualElement.attachmentOrigin==null?Xa(this.view,this._moveManipulation,this.graphic):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(t){var n;const e=new Array,a=this._editGeometryOperations;for(const o of t)if(o.type==="vertex"&&a.canRemoveVertex(o.handle.component)){e.push(o.handle),this._removeManipulator(o),this._removeManipulator(this._getManipulatorInfoFromHandle(o.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(o.handle.rightEdge));const s=a.removeVertices([o.handle]),r=(n=s.removedVertices)==null?void 0:n[0].createdEdge;r&&this._createVertexOrEdgeManipulator(r)}if(e.length>0){const o=e.map(r=>{const l=a.data.components.indexOf(r.component);return{coordinates:a.data.coordinateHelper.vectorToArray(r.pos),componentIndex:l,vertexIndex:r.index}});this.outputGeometry=a.data.geometry;const s=this._updateEventState(R.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:o.map(r=>r.coordinates),vertices:o}),this.destroyed)||s&&(this._updateEventState(R.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,a=e.action==="start"?Tt.NEW_STEP:Tt.ACCUMULATE_STEPS){const n=this._editGeometryOperations;n.moveVertices(t.map(o=>o.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,a),this.outputGeometry=n.data.geometry;for(const o of t)this._updateManipulatorPosition(o)}_offsetEdge(t,e){if(e.operation==null||e.signedDistance==null)return;const a=this._editGeometryOperations,n=e.operation.clone();n.distance=e.signedDistance,a.updateVertices([t.handle.leftVertex,t.handle.rightVertex],n),this.outputGeometry=a.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),e.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected,t.button===Fi.Right&&this._removeVertices([e])),e.type==="edge"&&t.button===Fi.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const a=this._manipulatorInfos.filter(n=>n.type==="vertex"&&n.manipulator.selected);a.length===1?this._updateTranslateVertexTooltip(a[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const{_tooltipOptions:a,_tooltip:n}=this;if(!a.enabled)return;const o=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case S.XY:n.info=this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new Me({tooltipOptions:a})),this._updateTranslateTooltipDistance(n.info,e,(s,r)=>At(s,r,o));break;case S.XY_AXIS:n.info=this._translateGraphicXYTooltipInfo??(this._translateGraphicXYTooltipInfo=new Ai({tooltipOptions:a})),this._updateTranslateTooltipDistance(n.info,e,(s,r)=>{const l=At(s,r,o);return Ve(l,Ye(e))});break;case S.Z:n.info=this._translateGraphicZTooltipInfo??(this._translateGraphicZTooltipInfo=new ei({tooltipOptions:a})),this._updateTranslateTooltipDistance(n.info,e,Xe)}n.info.tooltipOptions=a}_updateTranslateVertexTooltip(t,e,a){const{_tooltipOptions:n,_tooltip:o}=this;if(!n.enabled)return;const s=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case S.XY:o.info=this._translateVertexTooltipInfo??(this._translateVertexTooltipInfo=new Zo({tooltipOptions:n})),this._updateTranslateTooltipDistance(o.info,a,(l,h)=>At(l,h,s)),this._updateTooltipAreaOrTotalLength(o.info);break;case S.XY_AXIS:o.info=this._translateVertexXYTooltipInfo??(this._translateVertexXYTooltipInfo=new Yo({tooltipOptions:n})),this._updateTranslateTooltipDistance(o.info,a,(l,h)=>{const d=At(l,h,s);return Ve(d,Ye(a))}),this._updateTooltipAreaOrTotalLength(o.info);break;case S.Z:o.info=this._translateVertexZTooltipInfo??(this._translateVertexZTooltipInfo=new No({tooltipOptions:n})),this._updateTranslateTooltipDistance(o.info,a,Xe)}const r=Bo(t.elevationAlignedLocation);r!=null&&(o.info.elevation=Do({actual:r})),o.info.tooltipOptions=n}_updateTranslateTooltipDistance(t,e,a){if(e!=null&&e.action!=="end"){const{mapStart:n,mapEnd:o}=e,s=a(n,o);t.distance=s??_t}else t.distance=_t}_updateTooltipAreaOrTotalLength(t){const{geometry:e}=this.graphic;if(e==null)return t.area=null,void(t.totalLength=null);const a=this._graphicState.isDraped?"on-the-ground":"absolute-height";t.area=e.type==="polygon"?Wo(e,a):null,t.totalLength=e.type==="polyline"?Mo(e,a):null}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function fa(i,t){return Math.atan2(t[1]-i[1],t[0]-i[0])+Math.PI/2}function rr(i,t,e,a,n){if(i){const o=n.toXYZ(n.pointToVector(e)),s=jn(a,o,w.get()),r=bo(s,o,n.spatialReference);if(r!=null)return ye(r.value*Math.sign(t),r.unit)}return ye(t*$e(e.spatialReference),"meters")}p([c()],P.prototype,"_editGeometryOperations",void 0),p([c()],P.prototype,"_segmentLabels",void 0),p([c({constructOnly:!0})],P.prototype,"tool",void 0),p([c()],P.prototype,"_tooltip",void 0),p([c()],P.prototype,"inputGeometry",null),p([c()],P.prototype,"outputGeometry",void 0),p([c({readOnly:!0})],P.prototype,"updating",null),p([c()],P.prototype,"manipulators",null),p([c()],P.prototype,"view",null),p([c()],P.prototype,"graphic",null),p([c()],P.prototype,"enableZShape",null),p([c()],P.prototype,"enableZVertex",null),p([c()],P.prototype,"enableMoveGraphic",null),p([c()],P.prototype,"enableMidpoints",null),p([c()],P.prototype,"enableEdgeOffset",null),p([c()],P.prototype,"_labelOptions",null),p([c()],P.prototype,"_tooltipOptions",null),p([c()],P.prototype,"_accentColor",null),P=p([V("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],P);const ce=be(0,0,void 0,Wn.WGS84),Te=H(),pi=1e-6;var ht,R,te;(function(i){i.Vertex=xt.Custom1,i.Edge=xt.Custom2})(ht||(ht={})),function(i){i[i.NONE=0]="NONE",i[i.MOVING=1]="MOVING",i[i.RESHAPING=2]="RESHAPING"}(R||(R={})),function(i){i[i.ALL=0]="ALL",i[i.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(te||(te={}));let N=class extends ft.EventedMixin(Qe){constructor(i){super(i),this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new La,this.tooltipOptions=new Ht,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const i=this._reshapeOperation=new P({tool:this});this.addHandles([i.on("reshape",t=>{t.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",t)}),i.on("move",t=>{t.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",t)}),i.on("vertex-add",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)}),i.on("vertex-remove",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)}),i.on("immediate-click",t=>this.emit("immediate-click",t)),this.view.on("pointer-down",["Shift"],t=>t.stopPropagation()),y(()=>this.graphic,()=>this._updateGraphic(),ae)]),this.finishToolCreation()}destroy(){this._reshapeOperation=C(this._reshapeOperation)}get updating(){var i;return((i=this._reshapeOperation)==null?void 0:i.updating)??!1}_updateGeometry(){const i=Kn(this.graphic);this._reshapeOperation.inputGeometry=i!=null?i.clone():null}_updateGraphic(){if(this.removeHandles("onGraphicGeometryChange"),this._updateGeometry(),Jn(this.graphic)!==Ia.SUPPORTED)return;const i=y(()=>{var t;return(t=this.graphic)==null?void 0:t.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},Le);this.addHandles(i,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(i){this._internalGeometryUpdate=!0;const{graphic:t}=this,{geometry:e}=t;(e==null?void 0:e.type)==="mesh"&&i.type==="point"?(t.geometry=e.centerAt(i),t.notifyGeometryChanged()):t.geometry=i,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){const{outputGeometry:i}=this._reshapeOperation;this.graphic!=null&&i&&this._updateGeometryInternally(i.clone())}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping();const i=this._reshapeOperation.undo(),{outputGeometry:t}=this._reshapeOperation;i&&t&&this._updateGeometryInternally(t.clone())}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){this.snappingManager!=null&&this.snappingManager.doneSnapping();const i=this._reshapeOperation.redo(),{outputGeometry:t}=this._reshapeOperation;i&&t&&this._updateGeometryInternally(t.clone())}onInputEvent(i){i.type!=="key-down"||i.key!=="Delete"&&i.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};p([c()],N.prototype,"_reshapeOperation",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"view",void 0),p([c({constructOnly:!0})],N.prototype,"graphic",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableZShape",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableZVertex",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableMoveGraphic",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableMidpoints",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableEdgeOffset",void 0),p([c()],N.prototype,"type",void 0),p([c({constructOnly:!0,type:La})],N.prototype,"labelOptions",void 0),p([c({constructOnly:!0,type:Ht})],N.prototype,"tooltipOptions",void 0),p([c({constructOnly:!0})],N.prototype,"snappingManager",void 0),p([c()],N.prototype,"updating",null),p([c()],N.prototype,"automaticManipulatorSelection",void 0),N=p([V("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],N);let Mt=class extends Ke{constructor(t){super(t),this.type="transform-rotate",this.rotation=null,this.rotationPrecision=null,this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic"}};p([c()],Mt.prototype,"type",void 0),p([c()],Mt.prototype,"rotation",void 0),p([c()],Mt.prototype,"rotationPrecision",void 0),p([c()],Mt.prototype,"orientation",void 0),p([c()],Mt.prototype,"orientationPrecision",void 0),p([c()],Mt.prototype,"rotationType",void 0),Mt=p([V("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],Mt);let Rt=class extends Ke{constructor(i){super(i),this.type="transform-scale",this.size=null,this.sizeUnit=null,this.sizePrecision=null}};p([c()],Rt.prototype,"type",void 0),p([c()],Rt.prototype,"scale",void 0),p([c()],Rt.prototype,"size",void 0),p([c()],Rt.prototype,"sizeUnit",void 0),p([c()],Rt.prototype,"sizePrecision",void 0),Rt=p([V("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],Rt);let gt=class extends Ke{constructor(t){super(t),this.type="transform-absolute",this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic",this.size=null,this.sizePrecision=null,this.sizeUnit=null}};p([c()],gt.prototype,"type",void 0),p([c()],gt.prototype,"orientation",void 0),p([c()],gt.prototype,"orientationPrecision",void 0),p([c()],gt.prototype,"rotationType",void 0),p([c()],gt.prototype,"size",void 0),p([c()],gt.prototype,"sizePrecision",void 0),p([c()],gt.prototype,"sizeUnit",void 0),gt=p([V("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],gt);var A;(function(i){i.ScaleIn=xt.Custom2,i.ScaleOut=xt.Custom3,i.RotateLeft=xt.Custom4,i.RotateRight=xt.Custom5,i.Unlocked=xt.Custom7,i.DelayedFocused=xt.Custom8,i.TouchInput=xt.Custom12})(A||(A={}));let bt=class extends Lt{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(i){this._ringManipulator.location=i}set elevationAlignedLocation(i){this._ringManipulator.elevationAlignedLocation=i}get grabbing(){return this._ringManipulator.grabbing}set interactive(i){this._ringManipulator.interactive=i}get updating(){return!!this._activeAnimation}constructor(i){super(i),this.mode=null,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=Bs,this._absoluteTooltipInfo=null,this._scaleTooltipInfo=null,this._rotateTooltipInfo=null,this.events=new ft,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>{var t;return((t=this._scaleRotateDragData)==null?void 0:t.mode)==="scale"?this.adapter.scale:1}}initialize(){this._tooltip=new we({view:this.tool.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([Zt(()=>!this.tooltipOptions.enabled,()=>this._tooltip.clear(),$),y(()=>{const{adapter:i}=this,{info:t}=this._tooltip;return t===this._absoluteTooltipInfo&&this.getFocused()?[t,i.size,i.orientationClockwise]:[null]},([i])=>{i&&this._updateFocusTooltip()})])}destroy(){var i;(i=this._activeAnimation)==null||i.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=C(this._tooltip)}startAnimation(i){this.cancelActiveAnimation(),i.start();const t=Qn({update:({deltaTime:e})=>{i.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...i,frameTask:t}}cancelActiveAnimation(){var i;(i=this._activeAnimation)==null||i.frameTask.remove(),this._activeAnimation=C(this._activeAnimation)}forEachManipulator(i){i(this._ringManipulator,D.SCALE_ROTATE)}_createManipulator(){const i=this._createRingManipulator();this._ringManipulator=i,this.tool.manipulators.add(i);const t=this.tool.graphicState.graphic,e=dt(i,(a,n,o)=>{this._scaleRotateDragData=null;const s=this.adapter.startInteraction(),r={mode:"none",origin:ue(a.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=r,this._updateDragState();const l=w.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(a.renderLocation,l),n.next(Ei(this.tool.view,Pa(a.renderLocation,l,wi()))).next(h=>{const d=Se(h.plane),u=Fa(h.renderStart,h.renderEnd,r.origin,d),g=eo.shortestSignedDiff(r.angle,u);r.angleDir=ui(r.angleDir+g,-pa,pa),r.angle=u;const _=lr(r,h),m=_-this.adapter.scale;if(r.scaleDir=ui(r.scaleDir+m,-ha,ha),this._onScaleChanged(),r.mode==="none"){const f=this.mode||hr(h,h.plane,r.origin,this.tool.view.state.camera);if(f!=null){switch(f){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}r.mode=f}}switch(r.mode){case"rotate":s.state.angle=r.initialAngle+u;break;case"scale":s.state.scale=_,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),h.action){case"start":case"update":switch(r.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:me(r.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,xScale:_,yScale:_})}break;case"end":switch(r.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:me(r.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:_,yScale:_})}}return h.action==="end"&&(this.startAnimation(va(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),s.done()),h}).next(this._updateTooltipPipelineStep(r)),o.next(()=>{if(s.cancel(),this._scaleRotateDragData!=null){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:1,yScale:1})}this.startAnimation(va(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this.addHandles([e,i.events.on("focus-changed",a=>{a.action==="focus"?this.startAnimation(pr(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),i.events.on("immediate-click",a=>{a.stopPropagation()}),y(()=>{var a;return(a=this.tool.graphicState)==null?void 0:a.displaying},a=>this._ringManipulator.available=a,$)])}_updateTooltipPipelineStep(i){return t=>{const e=this.tooltipOptions;if(!e.enabled)return t;if(t.action==="end")return this._updateFocusTooltip(),t;const a=this._tooltip,n=this.tooltipOptions.visualVariables;switch(i.mode){case"scale":{a.info=this._scaleTooltipInfo??(this._scaleTooltipInfo=new Rt({tooltipOptions:e}));const{size:o,scale:s}=this.adapter,r=n==null?void 0:n.size,l=a.info;l.tooltipOptions=e,l.scale={value:s},l.size=o!=null?ye(o,"meters"):void 0,l.sizePrecision=Ge(r==null?void 0:r.valueType),l.sizeUnit=r==null?void 0:r.unit;break}case"rotate":{a.info=this._rotateTooltipInfo??(this._rotateTooltipInfo=new Mt({tooltipOptions:e}));const{orientationClockwise:o,relativeAngleClockwise:s}=this.adapter,r=n==null?void 0:n.rotation,l=Ge(r==null?void 0:r.valueType),h=a.info;h.tooltipOptions=e,h.rotation=s!=null?si(s,"radians","geographic"):void 0,h.rotationPrecision=l,h.rotationType=(r==null?void 0:r.rotationType)??"geographic",h.orientation=o!=null?si(o,"radians","geographic"):void 0,h.orientationPrecision=l;break}}return t}}_updateFocusTooltip(){const{tooltipOptions:i,_tooltip:t}=this;if(i.enabled)if(this.getFocused()){const e=i.visualVariables,a=e==null?void 0:e.rotation,n=e==null?void 0:e.size,o=this.mode,{size:s,orientationClockwise:r}=this.adapter,l=r!=null&&(o==null||o==="rotate"),h=s!=null&&(o==null||o==="scale");t.info=this._absoluteTooltipInfo??(this._absoluteTooltipInfo=new gt({tooltipOptions:i}));const d=t.info;d.tooltipOptions=i,d.orientation=l?si(r,"radians","geographic"):void 0,d.orientationPrecision=Ge(a==null?void 0:a.valueType),d.rotationType=(a==null?void 0:a.rotationType)??"geographic",d.size=h?ye(s,"meters"):void 0,d.sizeUnit=n==null?void 0:n.unit,d.sizePrecision=Ge(n==null?void 0:n.valueType)}else t.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(A.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){var i;if(this._ringManipulator.updateStateEnabled(A.Unlocked,!(this._scaleRotateDragData!=null&&((i=this._scaleRotateDragData)==null?void 0:i.mode)!=="none")),this._scaleRotateDragData!=null)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(A.ScaleIn|A.ScaleOut,!1),this._ringManipulator.updateStateEnabled(A.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(A.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(A.RotateLeft|A.RotateRight,!1),this._ringManipulator.updateStateEnabled(A.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(A.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(A.ScaleIn|A.ScaleOut|A.RotateLeft|A.RotateRight,!1)}_updateManipulatorTransform(){const i=Ra(j.get(),this.adapter.angle,q(0,0,1));if(i==null)return;const t=this.getScale(),e=Pe(j.get(),ot(w.get(),t,t,t));this._ringManipulator.modelTransform=Re(j.get(),e,i)}_createRingManipulator(){const i=(T,K,nt)=>{const Dt=[],Gt=Math.ceil(qa*(K-T)/(2*Math.PI));for(let F=0;F<Gt+1;F++){const le=T+F*(K-T)/Gt;Dt.push(q(nt*Math.cos(le),nt*Math.sin(le),0))}return Dt},t=T=>i(0,2*Math.PI,T),e=T=>[[-T/2,0],[T/2,0],[T/2,li/2],[-T/2,li/2]],a=this._createMaterial(1),n=(T,K,nt=a)=>io(nt,e(K),T,[],[],!1),o=t(Xt),s=n(o,hi),r={left:new Array,right:new Array},l=[];for(let T=0;T<2;T++){const K=T*Math.PI-Math.PI/4,nt=Math.PI/2-Ys,Dt=K+nt,Gt=K+Math.PI/2-nt,F=i(Dt,Gt,Xs),le=n(F,Kt);l.push(F),l.push(i(Dt,Gt,na-hi/2)),r.left.push(le),r.right.push(le.instantiate());for(let ni=0;ni<2;ni++){const $i=ni===0,J=qe();if($i){Ca(J,J,[1,-1,1]),Ni(J,J,-Dt,[0,0,1]);const Vt=Math.round(sa*(F.length-1));J[12]=F[Vt][0],J[13]=F[Vt][1],J[14]=F[Vt][2]}else{Ni(J,J,Gt,[0,0,1]);const Vt=Math.round((1-sa)*(F.length-1));J[12]=F[Vt][0],J[13]=F[Vt][1],J[14]=F[Vt][2]}const Ci=Ie(a,Fs,0,Ns,li);Ga(Ci,J),($i?r.left:r.right).push(Ci)}}const h=[];for(let T=0;T<2;T++){const K=T*Math.PI-Math.PI/4,nt=Math.PI/2-Zs,Dt=K+nt,Gt=K+Math.PI/2-nt,F=i(Dt,Gt,na);h.push(n(F,Kt))}const d=this._createMaterial(.66),u=this._createMaterial(.5),g=this._createMaterial(.33),_=t(Xt+ra),m=t(Xt+la),f=n(_,Kt,d),M=n(m,Kt,g),b=t(Xt-ra),v=t(Xt-la),E=n(b,Kt,d),G=n(v,Kt,g);let X=[new x(s,A.DelayedFocused),new x(s.instantiate({material:u}),O.None)];this.mode&&this.mode!=="scale"||(X=X.concat([...h.map(T=>new x(T,A.DelayedFocused|A.Unlocked)),new x(f,A.DelayedFocused|A.ScaleIn),new x(M,A.DelayedFocused|A.ScaleIn),new x(E,A.DelayedFocused|A.ScaleOut),new x(G,A.DelayedFocused|A.ScaleOut)])),this.mode&&this.mode!=="rotate"||(X=X.concat([...r.right.map(T=>new x(T.instantiate(),A.DelayedFocused|A.Unlocked)),...r.left.map(T=>new x(T,A.DelayedFocused|A.RotateLeft)),...r.right.map(T=>new x(T,A.DelayedFocused|A.RotateRight))]));const Y=[o,...l];return new st({view:this.tool.view,renderObjects:X,autoScaleRenderObjects:!1,worldOriented:!0,radius:hi,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:k(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:Y,direction:q(0,0,1)}})}_createMaterial(i){const t=new Mi({cullFace:bi.Back,renderOccluded:U.Transparent,isDecoration:!0});return this.addHandles(y(()=>({color:to(this.tool.view.effectiveTheme.accentColor,i)}),e=>t.setParameters(e),$)),t}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:i=>this._ringIndicatorDelayMs=i,tooltip:this._tooltip}}};function lr(i,t){const e=z(w.get(),t.renderStart,i.origin),a=z(w.get(),t.renderEnd,i.origin),n=ne(e),o=ne(a);return n===0?0:o/n}function hr(i,t,e,a){const{renderStart:n,renderEnd:o}=i,s=De(n,a,w.get()),r=De(o,a,w.get());if(ao(s,r)<oa*oa)return null;const l=z(w.get(),n,e),h=zt(w.get(),l,Se(t)),d=n,u=Et(w.get(),d,h),g=De(e,a,w.get()),_=s,m=De(u,a,w.get()),f=z(w.get(),m,_),M=z(w.get(),s,g),b=Yi(_,f),v=Yi(g,M);return Zi(b,r)<Zi(v,r)?"rotate":"scale"}function De(i,t,e){return t.projectToScreen(i,ci),ot(e,ci[0],ci[1],0)}var oe;function va(i,t){let e=null,a=1;const n=()=>a;return{start:()=>{a=i.getScale(),e=i.getScale,i.getScale=n,t()},update:o=>(a+=((a+1)/2-a)*Math.min(o*js,1),t(),Math.abs(a-1)<.01?oe.STOP:oe.CONTINUE),destroy:()=>{e&&(i.getScale=e),t()}}}function pr(i,t,e){let a=0,n=null;const o=()=>!1;return{start:()=>{n=i.getFocused,i.getFocused=o,a=0,t()},update:s=>(a+=s,!(n!=null&&n())||a>=e.delayMs?oe.STOP:oe.CONTINUE),destroy:()=>{n&&(i.getFocused=n),t()}}}function Ge(i){switch(i){case"integer":case"long":return 0;default:return null}}p([c({constructOnly:!0})],bt.prototype,"tool",void 0),p([c({constructOnly:!0})],bt.prototype,"adapter",void 0),p([c({constructOnly:!0})],bt.prototype,"tooltipOptions",void 0),p([c()],bt.prototype,"mode",void 0),p([c()],bt.prototype,"_activeAnimation",void 0),p([c()],bt.prototype,"updating",null),bt=p([V("esri.views.3d.interactive.editingTools.transformGraphic.GraphicScaleRotateTransform")],bt),function(i){i[i.CONTINUE=0]="CONTINUE",i[i.STOP=1]="STOP"}(oe||(oe={}));const ci=Ze();function Qa(i){return i.geometry!=null&&i.geometry.type==="mesh"?cr(i.geometry):dr(i)}function cr(i){return i.vertexSpace.isRelative?ur(i,i.transform,i.vertexSpace):gr(i)}function dr(i){let t=i.geometry,e=null;return{undo(a){e=a.geometry,a.geometry=t},redo(a){t=a.geometry,a.geometry=e}}}function ur(i,t,e){let a=t==null?void 0:t.clone(),n=ue(e.origin),o=null,s=null;return{undo:r=>{var l;o=(l=i.transform)==null?void 0:l.clone(),s=ue(e.origin),i.transform=a,i.vertexSpace.origin=n,r.notifyMeshTransformChanged()},redo:r=>{var l;a=(l=i.transform)==null?void 0:l.clone(),n=ue(e.origin),i.transform=o,i.vertexSpace.origin=s,r.notifyMeshTransformChanged()}}}function gr(i){let t,e=i.vertexAttributes.clonePositional();return{undo:a=>{t=i.vertexAttributes.clonePositional(),i.vertexAttributes=e,a.notifyGeometryChanged()},redo:a=>{e=i.vertexAttributes.clonePositional(),i.vertexAttributes=t,a.notifyGeometryChanged()}}}let et=class extends Lt{constructor(i){super(i),this._interactionState=null}initialize(){this.addHandles([Zt(()=>{const i=this._interactionState;return i&&i.angle!==i.previousAngle?{interactionState:i,angle:i.state.angle}:null},({interactionState:i})=>{this._updateMeshRotation(i)},Le),Zt(()=>{const i=this._interactionState;return i&&i.scale!==i.previousScale?{interactionState:i,scale:i.state.scale}:null},({interactionState:i})=>{this._updateMeshSize(i)},Le)])}get initialAngle(){var i;return((i=this._interactionState)==null?void 0:i.initialAngle)??0}get angle(){var e;const i=this.geometry.transform;if(i==null)return((e=this._interactionState)==null?void 0:e.angle)??0;const t=oo(i.rotation)[2];return Math.abs(t)>.999999?je(so(i.rotation))*Math.sign(t):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){var i;return((i=this._interactionState)==null?void 0:i.scale)??1}startInteraction(){const i=new St({angle:this.angle});this._interactionState=i;const t=()=>{this._interactionState=null};return{state:i,done:t,cancel:()=>{i.cancel(),t()}}}createUndoRecord(){return Qa(this.graphic)}_updateMeshRotation(i){const{angle:t,previousAngle:e}=i;i.previousAngle=t;const{geometry:a}=this,{vertexSpace:n}=a,o=me(t-e);if(n.isGeoreferenced){const s=!n.isRelative&&this.viewingMode===gi.Global,r=this.geometry.anchor;this.geometry.rotate(0,0,o,{origin:r,geographic:s}),this.graphic.notifyGeometryChanged()}else{a.transform??(a.transform=new Bi);const{transform:s}=a,r=ro(0,0,o,_r);s.rotation=lo(s.rotation,r,s.rotation),this.graphic.notifyMeshTransformChanged()}}_updateMeshSize(i){const{scale:t,previousScale:e}=i;i.previousScale=t;const{geometry:a}=this,{vertexSpace:n}=a,o=t/e;if(n.isGeoreferenced){const s=!n.isRelative&&this.viewingMode===gi.Global,r=this.geometry.anchor;this.geometry.scale(o,{origin:r,geographic:s}),this.graphic.notifyGeometryChanged()}else{a.transform??(a.transform=new Bi);const{transform:s}=a;s.scale=It(s.scale,s.scale,o),this.graphic.notifyMeshTransformChanged()}}};p([c({constructOnly:!0})],et.prototype,"graphic",void 0),p([c({constructOnly:!0})],et.prototype,"geometry",void 0),p([c({constructOnly:!0})],et.prototype,"viewingMode",void 0),p([c()],et.prototype,"initialAngle",null),p([c()],et.prototype,"angle",null),p([c()],et.prototype,"angleClockwise",null),p([c()],et.prototype,"relativeAngle",null),p([c()],et.prototype,"relativeAngleClockwise",null),p([c()],et.prototype,"scale",null),p([c()],et.prototype,"_interactionState",void 0),et=p([V("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],et);let St=class extends Lt{get state(){const{angle:i,scale:t}=this;return{angle:i,scale:t}}constructor(i){super(i),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=i.angle,this.previousAngle=i.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};p([c()],St.prototype,"angle",void 0),p([c()],St.prototype,"initialAngle",void 0),p([c()],St.prototype,"previousAngle",void 0),p([c()],St.prototype,"previousScale",void 0),p([c()],St.prototype,"scale",void 0),p([c()],St.prototype,"state",null),St=p([V("InteractionState")],St);const _r=no();let L=class extends Lt{constructor(i){super(i),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(Zt(()=>this._interactionState!=null?this._interactionState.state:null,i=>{this._updateSymbol(i)},Le))}get initialAngle(){var i;return((i=this._interactionState)==null?void 0:i.initialAngle)??0}get angle(){return this._interactionState!=null?this._interactionState.angle:this._orientationReferenceSymbolLayer!=null?mr(this._orientationReferenceSymbolLayer.heading??0):0}get angleClockwise(){return-this.angle}get orientation(){return this.angle}get orientationClockwise(){return this.angleClockwise}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){var i;return((i=this._interactionState)==null?void 0:i.scale)??1}get size(){const i=this._sizeReferenceSymbolLayer;if(i==null)return null;const t=this.findLayerView(),e=this._graphicSymbol;if(t==null||e==null||e.type!=="point-3d")return null;const a=t.getSymbolLayerSize(e,i);if("size"in a&&a.size!=null)return a.size;const n=this.sizeAxis;return!("width"in a)||a.width==null||n!=null&&n!=="width"&&n!=="all"&&n!=="width-and-depth"?!("depth"in a)||i.depth==null||n!=null&&n!=="depth"&&n!=="all"&&n!=="width-and-depth"?!("height"in a)||i.height==null||n!=null&&n!=="height"&&n!=="all"?null:a.height:a.depth:a.width}get _sizeReferenceSymbolLayer(){const i=this._graphicSymbol;return i==null||i.symbolLayers.length===0?null:i.symbolLayers.find(t=>t.type==="object")}get _orientationReferenceSymbolLayer(){const i=this._graphicSymbol;return i==null||i.symbolLayers.length===0?null:i.symbolLayers.find(t=>t.type==="object"&&t.heading!=null)}get _graphicSymbol(){var i;return((i=this.graphic)==null?void 0:i.symbol)!=null&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(i){this.graphic.symbol=i}startInteraction(){const i=this._graphicSymbol,t=this.findLayerView();if(this._interactionState!=null||i==null||t==null)return fr;const e=i.symbolLayers.map(r=>r.type==="object"?t.getSymbolLayerSize(i,r):null).toArray(),a=i.clone(),n=this.angle,o=new wt({originalSymbol:a,angle:n,initialSizes:e});this._interactionState=o;const s=()=>{this._interactionState=null};return{state:o,done:s,cancel:()=>{this._graphicSymbol=a,s()}}}createUndoRecord(){let i=this.graphic.symbol,t=null;return{undo:e=>{t=e.symbol,e.symbol=i},redo:e=>{i=e.symbol,e.symbol=t}}}_updateSymbol({scale:i,angle:t,originalSymbol:e,initialSizes:a}){const n=this._graphicSymbol;if(n==null||n.type!=="point-3d")return;const o=n.clone(),s=-me(t-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(e,o,(l,h,d)=>{const u=(l.heading??0)+s;h.heading!==u&&(h.heading=u,r=!0);const g=a[d];if(g!=null&&"width"in g){g.width=this.sizeFilter(g.width),g.height=this.sizeFilter(g.height),g.depth=this.sizeFilter(g.depth);const _=g.width*i;h.width!==_&&(h.width=_,r=!0);const m=g.depth*i;h.depth!==m&&(h.depth=m,r=!0);const f=g.height*i;h.height!==f&&(h.height=f,r=!0)}}),r&&(this._graphicSymbol=o)}_forEachObjectSymbolLayerPair(i,t,e){i.symbolLayers.forEach((a,n)=>{const o=t.symbolLayers.at(n);a.type==="object"&&o.type==="object"&&e(a,o,n)})}};function mr(i){return-je(i)}p([c()],L.prototype,"initialAngle",null),p([c()],L.prototype,"angle",null),p([c()],L.prototype,"angleClockwise",null),p([c()],L.prototype,"orientation",null),p([c()],L.prototype,"orientationClockwise",null),p([c()],L.prototype,"relativeAngle",null),p([c()],L.prototype,"relativeAngleClockwise",null),p([c()],L.prototype,"scale",null),p([c()],L.prototype,"size",null),p([c()],L.prototype,"sizeAxis",void 0),p([c({constructOnly:!0})],L.prototype,"graphic",void 0),p([c()],L.prototype,"_interactionState",void 0),p([c({constructOnly:!0})],L.prototype,"findLayerView",void 0),p([c({constructOnly:!0})],L.prototype,"sizeFilter",void 0),p([c()],L.prototype,"_sizeReferenceSymbolLayer",null),p([c()],L.prototype,"_orientationReferenceSymbolLayer",null),p([c()],L.prototype,"_graphicSymbol",null),L=p([V("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],L);const fr={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let wt=class extends Lt{get state(){const{originalSymbol:i,angle:t,initialAngle:e,scale:a,initialSizes:n}=this;return{originalSymbol:i,angle:t,initialAngle:e,scale:a,initialSizes:n}}constructor(i){super(i),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=i.angle}};p([c()],wt.prototype,"originalSymbol",void 0),p([c()],wt.prototype,"angle",void 0),p([c()],wt.prototype,"initialAngle",void 0),p([c()],wt.prototype,"initialSizes",void 0),p([c()],wt.prototype,"scale",void 0),p([c()],wt.prototype,"state",null),wt=p([V("InteractionState")],wt);let Q=class extends ft.EventedMixin(Qe){constructor(i){super(i),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Ht,this.type="transform-3d",this._updatingHandles=new Si,this._scaleRotate=null,this._tooltip=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{graphic:i,view:t}=this;this.graphicState=new at({graphic:i}),this.addHandles(y(()=>this.tooltipOptions.enabled,o=>{this._tooltip=o?new we({view:t}):C(this._tooltip)},ae)),this._moveManipulation=new Yt({tool:this,view:t,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Nt(i),radius:Yt.radiusForSymbol(i.symbol)}),this._moveManipulation.forEachManipulator(o=>this.addHandles(o.events.on("immediate-click",s=>{this.emit("immediate-click",{...s,graphic:i}),s.stopPropagation()})));const e=o=>s=>{this.addHandles(s.events.on("focus-changed",({action:r})=>{const l=this._tooltip;l!=null&&(r==="focus"?this._updateMoveTooltip(o):l.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(e(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(e(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(e(S.Z));const a=k(i);this._moveManipulation.elevationInfo=a,this.addHandles(Ti(this.graphicState));const{geometry:n}=i;if(this._moveManipulation.createGraphicDragPipeline((o,s,r,l,h)=>{if(n!=null&&o===S.XY){const{snappingStep:d,cancelSnapping:u}=Ue({snappingContext:new ke({elevationInfo:a,pointer:h,editGeometryOperations:ti.fromGeometry(new ho({spatialReference:n.spatialReference}),t.state.viewingMode),visualizer:new ve,excludeFeature:i}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});l=l.next(u),r=r.next(Uo(this.view,a)).next(...d)}return{steps:r=r.next(d=>(this._updateMoveTooltip(o,d),d)),cancel:l}},this.graphicState,o=>{const{action:s,graphic:r,dxScreen:l,dyScreen:h}=o,d={graphic:r,dxScreen:l,dyScreen:h};switch(s){case"start":this.emit("graphic-translate-start",d),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",d);break;case"end":this.emit("graphic-translate-stop",d)}}),this._moveManipulation.angle=this._scaleRotate!=null?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.addHandles(y(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const o=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new bt({tool:this,mode:o,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.addHandles(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.addHandles([ii({view:this.view,graphic:this.graphic,forEachManipulator:o=>this._forEachManipulator(o),onManipulatorsChanged:()=>Z()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),y(()=>t.scale,()=>this._updateMoveAngle())].filter(po)),this.addHandles(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(o=>{o instanceof st&&this.addHandles(o.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=C(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=C(this._scaleRotate),this._scaleRotateAdapter=C(this._scaleRotateAdapter),this._updatingHandles.destroy(),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){this._scaleRotate!=null&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){var i,t,e;return this.graphic.geometry!=null&&this.graphic.geometry.type==="mesh"?new et({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new L({graphic:this.graphic,sizeFilter:a=>this._enforceNonZeroSize(a),findLayerView:()=>this.view.allLayerViews.find(a=>a.layer===this.graphic.layer),sizeAxis:((e=(t=(i=this.tooltipOptions)==null?void 0:i.visualVariables)==null?void 0:t.size)==null?void 0:e.axis)??null})}_forEachManipulator(i){var t,e;(t=this._moveManipulation)==null||t.forEachManipulator(i),(e=this._scaleRotate)==null||e.forEachManipulator(i)}_hideManipulatorsForGraphicState(){return y(()=>this.graphicState.displaying,i=>{this._forEachManipulator(t=>t.available=i),this._moveManipulation.zManipulation.available=i&&this.enableZ&&Nt(this.graphic)})}_createGeometryUndoRecord(){return Qa(this.graphic)}set snapToScene(i){this._moveManipulation&&(this._moveManipulation.snapToScene=i),this._set("snapToScene",i)}get updating(){var i;return this._updatingHandles.updating||!!((i=this._scaleRotate)!=null&&i.updating)}set location(i){this._moveManipulation.location=i,this._scaleRotate&&(this._scaleRotate.location=i)}set elevationAlignedLocation(i){this._moveManipulation.elevationAlignedLocation=i,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=i)}reset(){}onHide(){var i;(i=this._scaleRotate)==null||i.cancelActiveAnimation()}_onScaleChanged(){this._scaleRotate!=null&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){this.view.state.viewingMode===gi.Local||this.view.scale<Ws?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){Xa(this.view,this,this.graphic)}_enforceNonZeroSize(i){return i||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(i,t){const{tooltipOptions:e,_tooltip:a}=this;if(a==null)return;a.clear();const n=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(i){case S.XY:a.info=this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new Me({tooltipOptions:e})),this._updateMoveTooltipDistance(a.info,t,(o,s)=>At(o,s,n));break;case S.XY_AXIS:a.info=this._translateGraphicXYTooltipInfo??(this._translateGraphicXYTooltipInfo=new Ai({tooltipOptions:e})),this._updateMoveTooltipDistance(a.info,t,(o,s)=>{const r=At(o,s,n);return Ve(r,Ye(t))});break;case S.Z:a.info=this._translateGraphicZTooltipInfo??(this._translateGraphicZTooltipInfo=new ei({tooltipOptions:e})),this._updateMoveTooltipDistance(a.info,t,Xe)}a.info.tooltipOptions=e}_updateMoveTooltipDistance(i,t,e){if(t!=null&&t.action!=="end"){const{mapStart:a,mapEnd:n}=t,o=e(a,n);i.distance=o??_t}else i.distance=_t}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:this._scaleRotate!=null?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:i=>this._scaleRotate!=null?this._scaleRotate.test.setRingIndicatorDelayMs(i):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};p([c({constructOnly:!0,nonNullable:!0})],Q.prototype,"view",void 0),p([c({constructOnly:!0,nonNullable:!0})],Q.prototype,"graphic",void 0),p([c({constructOnly:!0,nonNullable:!0})],Q.prototype,"enableZ",void 0),p([c()],Q.prototype,"enableRotation",void 0),p([c()],Q.prototype,"enableScaling",void 0),p([c({constructOnly:!0,type:Ht})],Q.prototype,"tooltipOptions",void 0),p([c()],Q.prototype,"graphicState",void 0),p([c({value:!1})],Q.prototype,"snapToScene",null),p([c({constructOnly:!0})],Q.prototype,"snappingManager",void 0),p([c({readOnly:!0})],Q.prototype,"type",void 0),p([c({readOnly:!0})],Q.prototype,"updating",null),Q=p([V("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],Q);let vr=class{constructor(t,e,a,n){this._tool=t,this._graphicState=e,this._editGeometryOperations=a,this._bounds=n,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const o=this._tool,s=o.view;this.moveXYGraphicManipulation=new Ri({view:s,tool:o,graphicState:this._graphicState}),o.addHandles(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=new qo(s,Ko.CENTER_ON_CALLOUT),this.moveZManipulator.state|=Jo,o.manipulators.add(this.moveZManipulator),o.addHandles([this._createMoveZDragPipeline()]),o.addHandles([o.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null})])}destroy(){this.moveXYGraphicManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(t){this.moveXYGraphicManipulation.forEachManipulator(t),t(this.moveZManipulator,D.TRANSLATE_Z)}updateManipulators(t,e){const a=this.moveZManipulator,n=co(j.get(),t,Math.PI);n[12]=0,n[13]=0,n[14]=0,a.modelTransform=n,a.renderLocation=z(w.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.moveXYGraphicManipulation.grabbing||this.moveXYGraphicManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const t=this._tool.tooltipOptions;return this._moveXYTooltipInfo??(this._moveXYTooltipInfo=new Me({tooltipOptions:t}))}_computeMoveZTooltipInfo(){const t=this._tool,e=t.tooltipOptions,a=this._moveZTooltipInfo??(this._moveZTooltipInfo=new ei({tooltipOptions:e}));if(this.moveZManipulator.dragging){const n=this._bounds,o=n.mapBoundsStart.origin,s=n.mapBounds.origin,r=jo(o,s,this._tool.view.spatialReference);if(r==null)return null;a.distance=r}else a.distance=ye(0,t.moveUnit);return a}_updateMoveTooltip(t,e){if(e===S.XY||e===S.XY_AXIS){const a=At(t.mapStart,t.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");a!=null&&this._moveXYTooltipInfo!=null&&(this._moveXYTooltipInfo.distance=a)}return t}_createMoveXYGraphicDragPipeline(){return this.moveXYGraphicManipulation.createDragPipeline((t,e,a)=>this._applyGraphicMoveSteps(e,a,S.XY))}_createMoveZDragPipeline(){const t=this._editGeometryOperations.data.spatialReference;return dt(this.moveZManipulator,(e,a,n)=>{const o=ue(e.renderLocation),s=a.next(Na(this._tool.view,o,t)).next(se());this._applyGraphicMoveSteps(s,n,S.Z)})}_applyGraphicMoveSteps(t,e,a){const n=this._tool,o=n.graphic,s=t.next(r=>(r.action==="start"&&(n.inputState={type:"move"},this._bounds.backupMapBounds(),n.emit("graphic-translate-start",{graphic:o,dxScreen:r.screenDeltaX,dyScreen:r.screenDeltaY})),r)).next(Qt()).next(this._moveDragUpdateGeometry()).next(r=>{const l={graphic:o,dxScreen:r.screenDeltaX,dyScreen:r.screenDeltaY};switch(r.action){case"start":case"update":(r.mapEnd.x-r.mapStart.x||r.mapEnd.y-r.mapStart.y||(r.mapEnd.z??0)-(r.mapStart.z??0))&&n.emit("graphic-translate",l);break;case"end":n.inputState=null,n.emit("graphic-translate-stop",l)}return r}).next(r=>this._updateMoveTooltip(r,a));return e.next(()=>{n.inputState!=null&&n.emit("graphic-translate-stop",{graphic:o,dxScreen:0,dyScreen:0}),n.cancel()}),s}_moveDragUpdateGeometry(){const t=this._tool;return e=>{if(t.inputState==null||t.inputState.type!=="move")return e;const a=[];for(const s of this._editGeometryOperations.data.components)a.push(...s.vertices);const n=e.action==="start"?Tt.NEW_STEP:Tt.ACCUMULATE_STEPS,o=this._editGeometryOperations.moveVertices(a,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,n);return Je(o,this._bounds.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,e}}};class yr{constructor(t,e,a){var r;this._tool=t,this._editGeometryOperations=e,this._bounds=a,this._rotateTooltipInfo=null,this._startAngle=0,this._endAngle=0;const n=this._tool,o=n.view,s=!((r=o._stage)!=null&&r.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this.rotateManipulator=new Qo(o,(l,h)=>Po(o.textures,{accentColor:l,contrastColor:h,preMultiplyAlpha:s})),n.addHandles([this.rotateManipulator.events.on("grab-changed",l=>this._onRotateGrab(l)),this._createRotateDragPipeline(this.rotateManipulator)]),n.manipulators.add(this.rotateManipulator),n.addHandles([n.on("graphic-rotate-start",l=>{this._startAngle=l.angle}),n.on("graphic-rotate",l=>{this._endAngle=l.angle}),n.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0})])}destroy(){this._tool.manipulators.remove(this.rotateManipulator),this.rotateManipulator.destroy()}forEachManipulator(t){t(this.rotateManipulator,D.ROTATE)}updateManipulators(t,e){const a=this._bounds.mapBounds.plane[2]<0?Math.PI:0,n=$a(j.get(),t,a);n[12]=0,n[13]=0,n[14]=0,this.rotateManipulator.modelTransform=n,this.rotateManipulator.renderLocation=Et(w.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.rotateManipulator.focused?this._computeRotateTooltipInfo():null}_computeRotateTooltipInfo(){const t=this._tool.tooltipOptions,e=this._rotateTooltipInfo??(this._rotateTooltipInfo=new rs({tooltipOptions:t}));return e.angle=this._startAngle-this._endAngle,e}_onRotateGrab({action:t,screenPoint:e}){const a=this._tool,n=this._bounds;if(t!=="start"||!e)return;const o=ts(n.displayBounds,a.view.renderCoordsHelper,es.HEADING,wi()),s=Ha(a.view.state.camera,e);Va(o,s,w.get())&&(n.backupMapBounds(),a.inputState={type:"rotate",rotatePlane:o})}_createRotateDragPipeline(t){const e=this._tool,a=e.graphic;return dt(t,(n,o,s)=>{const r=e.inputState;r!=null&&(o.next(l=>(l.action==="start"&&e.emit("graphic-rotate-start",{graphic:a,angle:0}),l)).next(Ei(e.view,r.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(r)).next(this._rotateDragUpdateGeometry()).next(l=>{const h={graphic:a,angle:me(l.rotateAngle)};switch(l.action){case"start":case"update":e.emit("graphic-rotate",h);break;case"end":e.inputState=null,e.emit("graphic-rotate-stop",h)}return l}),s.next(()=>{e.inputState!=null&&e.emit("graphic-rotate-stop",{graphic:a,angle:0}),e.cancel()}))})}_rotateDragRenderPlaneToRotate(t){return e=>{const a=Se(t.rotatePlane),n=Fa(e.renderStart,e.renderEnd,this._bounds.displayBounds.origin,a);return{...e,rotateAxis:a,rotateAngle:n}}}_rotateDragUpdateGeometry(){const t=this._tool,e=this._bounds;return a=>{const n=_i(H(),e.mapBoundsStart.origin),o=[];for(const l of this._editGeometryOperations.data.components)o.push(...l.vertices);const s=a.action==="start"?Tt.NEW_STEP:Tt.ACCUMULATE_STEPS,r=this._editGeometryOperations.rotateVertices(o,n,a.rotateAngle,s,Za.REPLACE);return fe(e.mapBoundsStart,e.mapBounds),Je(r,e.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,a}}}class Mr{constructor(t,e,a){this._tool=t,this._onDisplayBoundsChanged=e,this.mapBounds=ge(),this.mapBoundsStart=ge(),this.displayBounds=ge(),this._calculateMapBounds(a)}get displayBoundsMargin(){var n,o,s;const{view:t,graphic:e}=this._tool,a=((n=t.pointsOfInterest)==null?void 0:n.centerOnSurfaceFrequent.location)??((s=(o=e.geometry)==null?void 0:o.extent)==null?void 0:s.center);return a?br*t.pixelSizeAt(a):0}backupMapBounds(){fe(this.mapBounds,this.mapBoundsStart)}updateDisplayBounds(){this._calculateDisplayBounds(),this._onDisplayBoundsChanged()}_calculateMapBounds(t){const{view:e,attachmentOrigin:a}=this._tool,n=t.geometry,o=Es(n);Oa(o,o,-1);const s=e.spatialReference,r=n.spatialReference,l=a?e.pixelSizeAt(a)*uo(s)/$e(r):0;Go(o,t,Sr*l,this.mapBounds)}_calculateDisplayBounds(){const{view:t,attachmentOrigin:e,graphic:a}=this._tool;if(!a.geometry)return;const n=(e==null?void 0:e.z)??vi(this.mapBounds.origin,t.elevationProvider,Be.fromElevationInfo(k(a)),t.renderCoordsHelper),o=fe(this.mapBounds);o.origin[2]=n??0,wr(o,t.renderCoordsHelper,a.geometry.spatialReference,this.displayBoundsMargin,this.displayBounds)}}const br=10,Sr=80;function wr(i,t,e,a=0,n){n||(n=ge()),t.toRenderCoords(i.origin,e,n.origin);const o=w.get();Et(o,i.origin,i.basis1),Et(o,o,i.basis2),t.toRenderCoords(o,e,o);const s=w.get();Et(s,i.origin,i.basis1),z(s,s,i.basis2),t.toRenderCoords(s,e,s);const r=w.get();z(r,i.origin,i.basis1),z(r,r,i.basis2),t.toRenderCoords(r,e,r);const l=w.get();z(l,i.origin,i.basis1),Et(l,l,i.basis2),t.toRenderCoords(l,e,l);const h=Ut(w.get(),o,s,.5);z(h,h,n.origin);const d=Ut(w.get(),r,l,.5);z(d,n.origin,d),Ut(n.basis1,h,d,.5);const u=Ut(w.get(),l,o,.5);z(u,u,n.origin);const g=Ut(w.get(),s,r,.5);z(g,n.origin,g),Ut(n.basis2,u,g,.5);const _=zt(w.get(),n.basis1,n.basis2),m=zt(_,_,n.basis1);return di(m,m),It(n.basis2,m,ze(n.basis2,m)),It(n.basis1,n.basis1,1+a/ne(n.basis1)),It(n.basis2,n.basis2,1+a/ne(n.basis2)),go(n),n}function ya(i,t,e,a){const n=w.get();z(n,z(n,i.origin,i.basis1),i.basis2);const o=w.get();Ft(o,n,i.basis1,2);const s=w.get();Ft(s,o,i.basis2,2);const r=w.get();Ft(r,n,i.basis2,2),n[2]=o[2]=s[2]=r[2]=t;const l=a?"on-the-ground":"absolute-height",h=qi(Ee(n,o,e,l),Ee(r,s,e,l)),d=qi(Ee(o,s,e,l),Ee(n,r,e,l));return d==null||h==null?null:[h,d]}class xr{get zMax(){if(!this._zMaxDirty)return this._zMax;const t=this._editGeometryOperations.data;if(t.geometry.hasZ){const e=t.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const a of t.components)for(const n of a.vertices){const o=e.getZ(n.pos)??0;this._zMax=Math.max(o,this._zMax)}}else this._zMax=0;return this._zMaxDirty=!1,this._zMax}constructor(t,e,a,n,o){this._tool=t,this._graphicState=e,this._editGeometryOperations=a,this._bounds=n,this._preserveAspectRatioStep=o,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._scaleTooltipInfo=null,this._displayBoundsStart=ge(),this._displayBoundsMarginStart=0,this._startScale=de(),this._endScale=de(),this._sizeStart=null,this._zMax=0,this._zMaxDirty=!0;const s=this._tool,r=s.view;this.resizeManipulators=this._resizeHandles.map(l=>{const h=new is(r,l);return s.addHandles([h.events.on("grab-changed",d=>this._onResizeGrab(d)),this._createResizeDragPipeline(h,l)]),h}),s.manipulators.addMany(this.resizeManipulators),s.addHandles([s.on("graphic-scale-start",l=>{$t(this._startScale,l.xScale,l.yScale),$t(this._endScale,l.xScale,l.yScale)}),s.on("graphic-scale",l=>{$t(this._endScale,l.xScale,l.yScale)}),s.on("graphic-scale-stop",()=>{$t(this._startScale,0,0),$t(this._endScale,0,0)}),this._graphicState.on("changed",()=>{var l;((l=s.inputState)==null?void 0:l.type)!=="resize"&&(this._zMaxDirty=!0)})])}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){this.resizeManipulators.forEach(e=>t(e,D.SCALE))}updateManipulators(t,e){this.resizeManipulators.forEach((a,n)=>{as(a,this._resizeHandles[n],t,e)})}getUpdatedTooltipInfo(){return this.resizeManipulators.some(t=>t.focused)?this._computeScaleTooltipInfo():null}_computeScaleTooltipInfo(){const t=this._tool,e=t.tooltipOptions,a=this._scaleTooltipInfo??(this._scaleTooltipInfo=new ls({tooltipOptions:e})),n=t.graphic.geometry;if(n==null)return null;const o=ya(this._bounds.mapBounds,this.zMax,n.spatialReference,this._graphicState.isDraped);return o==null?null:(a.xSize=o[0],a.ySize=o[1],this._sizeStart!=null&&this.resizeManipulators.some(s=>s.dragging)?(a.xScale=o[0].value/this._sizeStart[0].value,a.yScale=o[1].value/this._sizeStart[1].value):(a.xScale=1,a.yScale=1),a)}_onResizeGrab({action:t,screenPoint:e}){const a=this._tool,n=this._bounds;if(t!=="start"||!e||!a.graphic.geometry)return;const o=Ha(a.view.state.camera,e);Va(n.displayBounds.plane,o,w.get())&&(n.backupMapBounds(),fe(n.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=n.displayBoundsMargin,this._sizeStart=ya(n.mapBoundsStart,this.zMax,a.graphic.geometry.spatialReference,this._graphicState.isDraped),a.inputState={type:"resize"})}_createResizeDragPipeline(t,e){const a=this._tool,n=a.graphic;return dt(t,(o,s,r)=>{a.inputState!=null&&(s.next(l=>(l.action==="start"&&a.emit("graphic-scale-start",{graphic:n,xScale:1,yScale:1}),l)).next(Ei(a.view,this._displayBoundsStart.plane)).next(l=>({...l,handle:e})).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._resizeDragUpdateGeometry()).next(l=>{const h={graphic:n,xScale:l.factor1,yScale:l.factor2};switch(l.action){case"start":case"update":a.emit("graphic-scale",h);break;case"end":a.inputState=null,a.emit("graphic-scale-stop",h)}return l}),r.next(()=>{a.inputState!=null&&a.emit("graphic-scale-stop",{graphic:n,xScale:1,yScale:1}),a.cancel()}))})}_resizeDragRenderPlaneToFactors(){const t=this._bounds;return e=>{const a=this._displayBoundsStart,n=e.handle.direction,o=t.displayBoundsMargin,s=this._displayBoundsMarginStart,r=_i(w.get(),a.origin);Ft(r,r,a.basis1,-n[0]),Ft(r,r,a.basis2,-n[1]);const l=z(w.get(),e.renderEnd,r),h=z(w.get(),e.renderStart,r),d=Ba(e.handle),u=Qi(a),g=Qi(t.displayBounds)/u,_=(m,f)=>{if(m===0)return 1;let M=ne(f),b=.5*m*ze(f,l)/M;const v=b<0?-1:1;d&&(b+=(M-.5*m*ze(f,h)/M)*v*g);const E=M<1.5*s?1:Ma;return M=Math.max(M-s,Ma),v>0&&(b-=o),v*Math.max(v*(b/M),E)};return{...e,factor1:_(n[0],a.basis1),factor2:_(n[1],a.basis2)}}}_resizeDragUpdateGeometry(){const t=this._tool,e=this._bounds;return a=>{const n=_i(H(),e.mapBoundsStart.origin);Ft(n,n,e.mapBoundsStart.basis1,-a.handle.direction[0]),Ft(n,n,e.mapBoundsStart.basis2,-a.handle.direction[1]);const o=$t(de(),e.mapBoundsStart.basis1[0],e.mapBoundsStart.basis1[1]);xa(o,o);const s=[];for(const h of this._editGeometryOperations.data.components)s.push(...h.vertices);const r=a.action==="start"?Tt.NEW_STEP:Tt.ACCUMULATE_STEPS,l=this._editGeometryOperations.scaleVertices(s,n,o,a.factor1,a.factor2,r,Za.REPLACE);return fe(e.mapBoundsStart,e.mapBounds),Je(l,e.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,a}}}const Ma=1e-6;class Or{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const e={...this._lastDragEvent,action:"update"};t&&this._adjustScaleFactors(e),this._next.execute(e)}this._enabled=t}createDragEventPipelineStep(){this._lastDragEvent=null;const t=new Ya;return this._next=t,[e=>(this._lastDragEvent=e.action!=="end"?{...e}:null,this._enabled&&this._adjustScaleFactors(e),e),t]}_adjustScaleFactors(t){const e=Ba(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):t.handle.direction[0]===0?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-e:e,t.factor2=t.factor2<0?-e:e}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}let tt=class extends ft.EventedMixin(Qe){constructor(i){super(i),this.enableZ=!0,this.enableScaling=!0,this.enableRotation=!0,this.tooltipOptions=new Ht,this._preserveAspectRatio=new Or,this.grabbing=!1,this.inputState=null,this._attachmentOrigin=null,this.type="transform-3d",this._outlineVisualElement=null}initialize(){const{view:i,graphic:t}=this,e=this._graphicState=new at({graphic:t}),a=t.geometry,n=this._editGeometryOperations=ti.fromGeometry(a,i.state.viewingMode),o=this._bounds=new Mr(this,()=>this._updateManipulators(),n.data);this._extentMove=new vr(this,e,n,o),this._extentScale=new xr(this,e,n,o,()=>this._preserveAspectRatio.createDragEventPipelineStep()),this._extentRotate=new yr(this,n,o),this.addHandles([y(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._extentMove.moveZManipulator,D.TRANSLATE_Z)),y(()=>this.enableScaling,()=>this._extentScale.forEachManipulator(h=>this._updateManipulatorAvailability(h,D.SCALE))),y(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._extentRotate.rotateManipulator,D.ROTATE))]),this._updateAllManipulatorAvailability();const s=ii({view:i,graphic:t,forEachManipulator:h=>this._forEachManipulator(h),onManipulatorsChanged:()=>Z()});if(s!=null){const{visualElement:h}=s;h instanceof Bt&&(this._outlineVisualElement=h,this.addHandles(h.events.on("attachment-origin-changed",()=>this._bounds.updateDisplayBounds()))),this.addHandles(s)}this.addHandles([e.on("changed",()=>this._onGeometryChanged()),y(()=>e.displaying,()=>this._updateAllManipulatorAvailability()),y(()=>e.isDraped,()=>this._graphicDrapedChanged(),$),y(()=>{var h;return(h=i.pointsOfInterest)==null?void 0:h.centerOnSurfaceFrequent.location},()=>o.updateDisplayBounds()),i.trackGraphicState(e)]);const r=h=>{this.addHandles(h.events.on("grab-changed",()=>{this.grabbing=h.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(r);const l=(h,d)=>{this.addHandles(h.events.on("immediate-click",u=>{d===D.TRANSLATE_XY&&this.emit("immediate-click",{...u,graphic:t}),u.stopPropagation()}))};this._forEachManipulator(l),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._extentMove.destroy(),this._extentScale.destroy(),this._extentRotate.destroy(),this._editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{view:i}=this,t=this._tooltip=new we({view:i}),e=()=>{t.info=this._getUpdatedTooltipInfo()};this.addHandles([this.on("graphic-translate-start",e),this.on("graphic-translate",e),this.on("graphic-translate-stop",()=>{this._tooltip.clear()}),this.on("graphic-rotate-start",e),this.on("graphic-rotate",e),this.on("graphic-rotate-stop",e),this.on("graphic-scale-start",e),this.on("graphic-scale",e),this.on("graphic-scale-stop",e)]),this._forEachManipulator(a=>{this.addHandles([a.events.on("focus-changed",e),a.events.on("grab-changed",e),a.events.on("drag",n=>{n.action==="cancel"?this._tooltip.clear():e()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this._extentMove.getUpdatedTooltipInfo()??this._extentScale.getUpdatedTooltipInfo()??this._extentRotate.getUpdatedTooltipInfo():null}_onGeometryChanged(){this._bounds.updateDisplayBounds()}_graphicDrapedChanged(){this.removeHandles(ba),this._bounds.updateDisplayBounds(),this._graphicState.isDraped&&this.addHandles(this.view.elevationProvider.on("elevation-change",i=>{this._attachmentOrigin!=null&&Da(i.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._bounds.updateDisplayBounds()}),ba)}_updateManipulators(){if(!this.visible)return;const i=this._bounds.displayBounds,t=ns(i,j.get());this._extentMove.updateManipulators(t,i),this._extentScale.updateManipulators(t,i),this._extentRotate.updateManipulators(t,i)}_updateAllManipulatorAvailability(){this._forEachManipulator((i,t)=>this._updateManipulatorAvailability(i,t))}_updateManipulatorAvailability(i,t){const e=this.grabbing&&!i.grabbing;if(i.interactive=!e,i instanceof st){const a=this._graphicState.displaying,n=this.enableZ&&Nt(this.graphic);switch(t){case D.ROTATE:i.available=a&&this.enableRotation;break;case D.SCALE:i.available=a&&(this.enableScaling||this.enableRotation||n),i.interactive=!e&&this.enableScaling,i.state=this.enableScaling?os:ss;break;case D.TRANSLATE_Z:i.available=a&&n;break;default:i.available=a}}}_forEachManipulator(i){this._extentMove.forEachManipulator(i),this._extentScale.forEachManipulator(i),this._extentRotate.forEachManipulator(i)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(i){this._preserveAspectRatio.enabled=i,this._set("preserveAspectRatio",i)}get moveUnit(){return _o(this.view.spatialReference)??"meters"}get attachmentOrigin(){var e,a;const i=this.graphic.geometry,t=this._graphicState.isDraped?null:(e=this._outlineVisualElement)==null?void 0:e.attachmentOrigin;return this._attachmentOrigin=t??Ua(this.view,this.graphic)??((a=i==null?void 0:i.extent)==null?void 0:a.center),this._attachmentOrigin}reset(){}cancel(){if(this.canUndo){const i=this._editGeometryOperations.undo();Wi(i,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}this.inputState=null}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(this.inputState!=null)this.view.activeTool=null;else if(this.canUndo){const i=this._editGeometryOperations.undo();Wi(i,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const i=this._editGeometryOperations.redo();Je(i,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get test(){return{moveZManipulator:this._extentMove.moveZManipulator,resizeManipulators:this._extentScale.resizeManipulators,rotateManipulator:this._extentRotate.rotateManipulator,tooltip:this._tooltip}}};p([c({constructOnly:!0,nonNullable:!0})],tt.prototype,"view",void 0),p([c({constructOnly:!0,nonNullable:!0})],tt.prototype,"graphic",void 0),p([c()],tt.prototype,"enableZ",void 0),p([c()],tt.prototype,"enableScaling",void 0),p([c()],tt.prototype,"enableRotation",void 0),p([c({constructOnly:!0,type:Ht})],tt.prototype,"tooltipOptions",void 0),p([c()],tt.prototype,"preserveAspectRatio",null),p([c()],tt.prototype,"moveUnit",null),p([c()],tt.prototype,"grabbing",void 0),p([c()],tt.prototype,"inputState",void 0),p([c({readOnly:!0})],tt.prototype,"type",void 0),tt=p([V("esri.views.3d.interactive.editingTools.transformGraphic.ExtentTransformTool")],tt);const ba="draped-elevation-changes";export{Wt as DrawGraphicTool3D,tt as ExtentTransformTool,vt as GraphicMoveTool,N as GraphicReshapeTool,Q as GraphicTransformTool};
