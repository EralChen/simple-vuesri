import{gf as E,aa as G,gg as J,gh as _,gi as S,gj as U,a7 as q,at as Q,gk as V,gl as X}from"./index--fOyh5XL.js";import{r as B,b as K,n as Y,e as Z,j as $,V as ee,Q as te}from"./cimAnalyzer-gy2zc7ye.js";import{i as ae}from"./CIMResourceManager-DfY8ZKN1.js";import{c as ie}from"./Rasterizer-ds90zaom.js";import"./BidiEngine-8z8MVveq.js";import"./labelPoint-lHI8rp7z.js";import"./Rect-pT1ASav_.js";import"./rasterizingUtils-O1m4724n.js";const T=I=>I!=null&&I.scaleFactor?I.scaleFactor:1,re=96/72;class de{constructor(t,e){this._spatialReference=t,this._avoidSDF=e,this._resourceCache=new Map,this._lazyImageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new B,this._cimResourceManager=new ae,this._rasterizer=new ie(this._cimResourceManager)}get _imageDataCanvas(){return this._lazyImageDataCanvas??(this._lazyImageDataCanvas=document.createElement("canvas")),this._lazyImageDataCanvas}get _imageDataContext(){return this._imageDataCanvas.getContext("2d",{willReadFrequently:!0})}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,e,o,i,a,s,l,r,d){if(!t)return null;const{data:g}=t;if(!g||g.type!=="CIMSymbolReference"||!g.symbol)return null;const{symbol:u}=g;s||(s=E(u));const f=await K.resolveSymbolOverrides(g,e,this._spatialReference,a,s,l,r),c=this._imageDataCanvas,y=this._cimResourceManager,p=[];Y.fetchResources(f,y,p),Y.fetchFonts(f,y,p),p.length>0&&await Promise.all(p);const{width:h,height:m}=o,x=se(s,h,m,i),n=Y.getEnvelope(f,x,y);if(!n)return null;const P=(window.devicePixelRatio||1)*re;let w=1,R=0,M=0;switch(u.type){case"CIMPointSymbol":case"CIMTextSymbol":{let k=1;n.width>h&&(k=h/n.width);let C=1;n.height>m&&(C=m/n.height),i==="preview"&&(n.width<h&&(k=h/n.width),n.height<m&&(C=m/n.height)),w=Math.min(k,C),R=n.x+n.width/2,M=n.y+n.height/2}break;case"CIMLineSymbol":{(d||n.height>m)&&(w=m/n.height),M=n.y+n.height/2;const k=n.x*w+h/2,C=(n.x+n.width)*w+h/2,{paths:z}=x;z[0][0][0]-=k/w,z[0][2][0]-=(C-h)/w}break;case"CIMPolygonSymbol":{R=n.x+n.width/2,M=n.y+n.height/2;const k=n.x*w+h/2,C=(n.x+n.width)*w+h/2,z=n.y*w+m/2,F=(n.y+n.height)*w+m/2,{rings:D}=x;k<0&&(D[0][0][0]-=k,D[0][3][0]-=k,D[0][4][0]-=k),z<0&&(D[0][0][1]+=z,D[0][1][1]+=z,D[0][4][1]+=z),C>h&&(D[0][1][0]-=C-h,D[0][2][0]-=C-h),F>m&&(D[0][2][1]+=F-m,D[0][3][1]+=F-m)}}c.width=h*P,c.height=m*P;const b=1;c.width+=2*b,c.height+=2*b;const v=this._imageDataContext,A=te.createIdentity();return A.translate(-R,-M),A.scale(w*P,-w*P),A.translate(h*P/2+b,m*P/2+b),v.clearRect(0,0,c.width,c.height),new Z(v,y,A,!0).drawSymbol(f,x),v.getImageData(0,0,c.width,c.height)}async analyzeCIMSymbol3D(t,e,o,i,a){const s=[],l=e?{geometryType:i,spatialReference:this._spatialReference,fields:e}:null,r=[];Y.fetchFonts(t.data.symbol,this._cimResourceManager,r),await Promise.all(r);const d=new $(this._cimResourceManager,l);let g;await d.analyzeSymbolReference(t.data,this._avoidSDF,s),G(a);for(const u of s)u.cim.type!=="CIMPictureMarker"&&u.cim.type!=="CIMPictureFill"&&u.cim.type!=="CIMPictureStroke"||(g||(g=[]),g.push(this._fetchPictureMarkerResource(u,a))),o&&u.type==="text"&&typeof u.text=="string"&&u.text.includes("[")&&(u.text=J(o,u.text,u.cim.textCase));return g&&await Promise.all(g),s}rasterizeCIMSymbol3D(t,e,o,i,a,s){const l=[];for(const r of t){i&&typeof i.scaleFactor=="function"&&(i.scaleFactor=i.scaleFactor(e,a,s));const d=this._getRasterizedResource(r,e,o,i,a,s);if(!d)continue;let g=0,u=d.anchorX||0,f=d.anchorY||0,c=!1,y=0,p=0;if(o==="esriGeometryPoint"){const h=T(i);if(y=_(r.offsetX,e,a,s)*h||0,p=_(r.offsetY,e,a,s)*h||0,r.type==="marker")g=_(r.rotation,e,a,s)||0,c=r.rotateClockwise??!1;else if(r.type==="text"){if(g=_(r.angle,e,a,s)||0,r.horizontalAlignment!==void 0)switch(r.horizontalAlignment){case"left":u=-.5;break;case"right":u=.5;break;default:u=0}if(r.verticalAlignment!==void 0)switch(r.verticalAlignment){case"top":f=.5;break;case"bottom":f=-.5;break;case"baseline":f=-.25;break;default:f=0}}}d!=null&&l.push({angle:g,rotateClockWise:c,anchorX:u,anchorY:f,offsetX:y,offsetY:p,rasterizedResource:d})}return this.getSymbolImage(l)}getSymbolImage(t){const e=document.createElement("canvas"),o=e.getContext("2d");let i=0,a=0,s=0,l=0;const r=[];for(let f=0;f<t.length;f++){const c=t[f],y=c.rasterizedResource;if(!y)continue;const p=y.size,h=c.offsetX,m=c.offsetY,x=c.anchorX,n=c.anchorY,P=c.rotateClockWise||!1;let w=c.angle,R=S(h)-p[0]*(.5+x),M=S(m)-p[1]*(.5+n),b=R+p[0],v=M+p[1];if(w){P&&(w=-w);const C=Math.sin(w*Math.PI/180),z=Math.cos(w*Math.PI/180),F=R*z-M*C,D=R*C+M*z,O=R*z-v*C,H=R*C+v*z,L=b*z-v*C,W=b*C+v*z,N=b*z-M*C,j=b*C+M*z;R=Math.min(F,O,L,N),M=Math.min(D,H,W,j),b=Math.max(F,O,L,N),v=Math.max(D,H,W,j)}i=R<i?R:i,a=M<a?M:a,s=b>s?b:s,l=v>l?v:l;const A=o.createImageData(y.size[0],y.size[1]);A.data.set(new Uint8ClampedArray(y.image.buffer));const k={offsetX:h,offsetY:m,rotateClockwise:P,angle:w,rasterizedImage:A,anchorX:x,anchorY:n};r.push(k)}e.width=s-i,e.height=l-a;const d=-i,g=l;for(let f=0;f<r.length;f++){const c=r[f],y=this._imageDataToCanvas(c.rasterizedImage),p=c.rasterizedImage.width,h=c.rasterizedImage.height,m=d-p*(.5+c.anchorX),x=g-h*(.5-c.anchorY);if(c.angle){const n=(360-c.angle)*Math.PI/180;o.save(),o.translate(S(c.offsetX),-S(c.offsetY)),o.translate(d,g),o.rotate(n),o.translate(-d,-g),o.drawImage(y,m,x),o.restore()}else o.drawImage(y,m+S(c.offsetX),x-S(c.offsetY))}const u=new U({x:d/e.width-.5,y:g/e.height-.5});return{imageData:e.width!==0&&e.height!==0?o.getImageData(0,0,e.width,e.height):o.createImageData(1,1),anchorPosition:u}}async _fetchPictureMarkerResource(t,e){const o=t.materialHash;if(!this._pictureMarkerCache.get(o)){const i=(await q(t.cim.url,{responseType:"image",signal:e==null?void 0:e.signal})).data;this._pictureMarkerCache.set(o,i)}}_imageDataToCanvas(t){const e=this._imageDataCanvas,o=this._imageDataContext;return e.width=t.width,e.height=t.height,o.putImageData(t,0,0),e}_imageTo32Array(t,e,o,i){const a=this._imageDataCanvas,s=this._imageDataContext;if(a.width=e,a.height=o,s.drawImage(t,0,0,e,o),i){s.save();const l=new Q(i);s.fillStyle=l.toHex(),s.globalCompositeOperation="multiply",s.fillRect(0,0,e,o),s.globalCompositeOperation="destination-atop",s.drawImage(t,0,0,e,o),s.restore()}return new Uint32Array(s.getImageData(0,0,e,o).data.buffer)}_getRasterizedResource(t,e,o,i,a,s){let l,r,d;if(t.type==="text")return this._rasterizeTextResource(t,e,i,a,s);({analyzedCIM:l,hash:r}=oe(t,e,a,s));const f=T(i);if(t.cim.type==="CIMPictureMarker"){const p=_(t.size,e,a,s)*f,{image:h,width:m,height:x}=this._getPictureResource(t,p,_(t.color,e,a,s));return d={image:h,size:[m,x],sdf:!1,simplePattern:!1,anchorX:t.anchorPoint?t.anchorPoint.x:0,anchorY:t.anchorPoint?t.anchorPoint.y:0},d}V(l,f,{preserveOutlineWidth:!1});const c=l;r+=o,i&&(r+=JSON.stringify(i));const y=this._resourceCache;return y.has(r)?y.get(r):(d=this._rasterizer.rasterizeJSONResource({cim:c,type:t.type,url:t.url,mosaicHash:r,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),y.set(r,d),d)}_rasterizeTextResource(t,e,o,i,a){var M,b,v;const s=T(o),l=_(t.text,e,i,a);if(!l||l.length===0)return null;const r=t.cim,d=_((r==null?void 0:r.fontFamilyName)||t.fontName,e,i,a),g=_(((M=r==null?void 0:r.font)==null?void 0:M.style)||t.style,e,i,a),u=_(((b=r==null?void 0:r.font)==null?void 0:b.weight)||t.weight,e,i,a),f=_(((v=r==null?void 0:r.font)==null?void 0:v.decoration)||t.decoration,e,i,a),c=_(t.size,e,i,a)*s,y=_(t.horizontalAlignment,e,i,a),p=_(t.verticalAlignment,e,i,a),h=X(_(t.color,e,i,a)),m=X(_(t.outlineColor,e,i,a)),x=_(t.outlineSize,e,i,a),n=t.backgroundColor!=null?X(t.backgroundColor):null,P=t.borderLineColor!=null?X(t.borderLineColor):null,w=t.borderLineWidth!=null?t.borderLineWidth:null,R={color:h,size:c,horizontalAlignment:y,verticalAlignment:p,font:{family:d,style:g,weight:u,decoration:f},halo:{size:x||0,color:m,style:g},backgroundColor:n,borderLine:P!=null&&w!=null?{color:P,size:w}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(l,R)}_getPictureResource(t,e,o){const i=this._pictureMarkerCache.get(t.materialHash);if(!i)return null;const a=i.height/i.width,s=e?a>1?S(e):S(e)/a:i.width,l=e?a>1?S(e)*a:S(e):i.height;return{image:this._imageTo32Array(i,s,l,o),width:s,height:l}}}function se(I,t,e,o){const a=-t/2+1,s=t/2-1,l=e/2-1,r=-e/2+1;switch(I){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[a,0],[0,0],[s,0]]]};default:return o==="legend"?{rings:[[[a,l],[s,0],[s,r],[a,r],[a,l]]]}:{rings:[[[a,l],[s,l],[s,r],[a,r],[a,l]]]}}}function oe(I,t,e,o){let i,a;return typeof I.materialHash=="function"?(i=(0,I.materialHash)(t,e,o),a=ee(I.cim,I.materialOverrides)):(i=I.materialHash,a=I.cim),{analyzedCIM:a,hash:i}}export{de as CIMSymbolRasterizer};
